services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./contracts/deployed_contracts.json:/app/deployed_contracts.json:ro
      - ./scripts:/app/scripts:ro
    env_file:
      - .env
    depends_on:
      - anvil
    restart: unless-stopped
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./web:/usr/share/nginx/html:ro
    restart: unless-stopped

  anvil:
    build:
      context: .
      dockerfile: anvil.Dockerfile
    ports:
      - "8545:8545"
    environment:
      - FOUNDRY_DISABLE_NIGHTLY_WARNING=true
    command: --port=8545 --accounts=10 --balance=10000 --chain-id=31337 --gas-limit=30000000
    restart: unless-stopped

  contracts:
    build:
      context: ./contracts
      dockerfile: Dockerfile
    volumes:
      - ./contracts:/app
      - contract_artifacts:/app/out
      - ./contracts/deployed_contracts.json:/app/deployed_contracts.json
    environment:
      - RPC_URL=http://anvil:8545
      - PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
    depends_on:
      - anvil
    profiles:
      - deploy
    command: >
      sh -c "
        echo 'Waiting for Anvil to be ready...' &&
        sleep 5 &&
        forge script script/Deploy.s.sol --rpc-url http://anvil:8545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast
      "

volumes:
  contract_artifacts:

networks:
  default:
    name: fundchain_network