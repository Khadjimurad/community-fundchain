// FundChain Frontend Application
// Comprehensive JavaScript for the Traceable Community Fund MVP

class FundChainApp {
  constructor() {
    this.baseURL = 'http://localhost:8000/api/v1';
    this.currentSection = 'dashboard';
    this.refreshInterval = 30000; // 30 seconds
    this.refreshTimer = null;
    this.votingTimer = null;
    this.walletAddress = null;
    this.autoRefreshEnabled = true; // New property
    
    this.init();
  }

  // Initialize the application
  init() {
    console.log('FundChainApp initializing...');
    this.setupEventListeners();
    this.loadInitialData();
    this.startAutoRefresh();
    
    // Wait for i18n initialization before updating the switch
    setTimeout(() => {
      this.updateAutoRefreshToggle();
    }, 100);
    
    console.log('FundChain App initialized successfully');
  }

  // Setup event listeners
  setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = e.target.dataset.section;
        this.switchSection(section);
      });
    });

    // Filters
    const categoryFilter = document.getElementById('category-filter');
    const statusFilter = document.getElementById('status-filter');
    
    if (categoryFilter) {
      categoryFilter.addEventListener('change', () => this.loadProjects());
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', () => this.loadProjects());
    }

    // Wallet address input
    const walletInput = document.getElementById('wallet-address');
    if (walletInput) {
      walletInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          this.loadPersonalStats();
        }
      });
    }
    
    // Language change event
    window.addEventListener('languageChanged', () => {
      this.updateAutoRefreshToggle();
      
      // Update headers and interface when language changes
      if (this.currentSection === 'voting') {
        this.loadVotingSection();
      }
    });
  }

  // Section switching
  switchSection(sectionName) {
    // Update navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
      section.classList.add('hidden');
    });

    // Show selected section
    const targetSection = document.getElementById(`${sectionName}-section`);
    if (targetSection) {
      targetSection.classList.remove('hidden');
      this.currentSection = sectionName;
      
      // Load section-specific data
      this.loadSectionData(sectionName);
    }
  }

  // Load data for specific section
  loadSectionData(section) {
    switch (section) {
      case 'dashboard':
        this.loadDashboard();
        break;
      case 'projects':
        this.loadProjectsSection();
        break;
      case 'voting':
        this.loadVotingSection();
        break;
      case 'treasury':
        this.loadTreasurySection();
        break;
      case 'personal':
        if (this.walletAddress) {
          this.loadPersonalStats();
        }
        break;
      case 'admin':
        this.loadAdminSection();
        break;
    }
  }

  // API helper function
  async fetchJSON(url, options = {}) {
    try {
      const response = await fetch(`${this.baseURL}${url}`, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });
      
      if (!response.ok) {
        // Try to get the error details from the response
        let errorDetails;
        try {
          errorDetails = await response.json();
          this.lastResponse = errorDetails; // Store for error handling
        } catch {
          errorDetails = { detail: response.statusText };
          this.lastResponse = errorDetails;
        }
        
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      this.lastResponse = data; // Store successful response
      return data;
    } catch (error) {
      console.error('API request failed:', error);
      this.showError(`API Error: ${error.message}`);
      throw error;
    }
  }

  // API helper function that doesn't show generic error messages (for specific error handling)
  async fetchJSONSilent(url, options = {}) {
    try {
      const response = await fetch(`${this.baseURL}${url}`, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });
      
      if (!response.ok) {
        // Try to get the error details from the response
        let errorDetails;
        try {
          errorDetails = await response.json();
          this.lastResponse = errorDetails; // Store for error handling
        } catch {
          errorDetails = { detail: response.statusText };
          this.lastResponse = errorDetails;
        }
        
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      this.lastResponse = data; // Store successful response
      return data;
    } catch (error) {
      console.error('API request failed:', error);
      // Note: No generic error message shown - let caller handle it
      throw error;
    }
  }

  // Load initial data
  async loadInitialData() {
    try {
      await this.loadDashboard();
      this.updateLastUpdated();
    } catch (error) {
      console.error('Failed to load initial data:', error);
      this.showError(i18n.t('messages.connection_error'));
    }
  }

  // Dashboard functions
  async loadDashboard() {
    try {
      // Load treasury stats
      const treasuryStats = await this.fetchJSON('/treasury/stats');
      this.updateTreasuryMetrics(treasuryStats);
      
      // Load projects
      await this.loadProjects();
      
      // Load overview stats
      const overviewStats = await this.fetchJSON('/stats/overview');
      this.updateOverviewMetrics(overviewStats);
      
    } catch (error) {
      console.error('Failed to load dashboard:', error);
    }
  }

  // Update treasury metrics
  updateTreasuryMetrics(stats) {
    this.updateElement('treasury-balance', this.formatETH(stats.total_balance));
    this.updateElement('total-balance', this.formatETH(stats.total_balance));
    this.updateElement('total-donations', this.formatETH(stats.total_donations));
    this.updateElement('total-allocated', this.formatETH(stats.total_allocated));
    this.updateElement('total-paid-out', this.formatETH(stats.total_paid_out));
    this.updateElement('active-projects', stats.active_projects_count);
  }

  // Update overview metrics
  updateOverviewMetrics(stats) {
    if (stats.projects) {
      this.updateElement('active-projects', stats.projects.active);
      this.updateElement('soft-cap-reached', stats.projects.completed);
    }
    
    // Use real data for 7-day donations if available
    if (stats.donations_7d !== undefined) {
      this.updateElement('donations-7d', this.formatETH(stats.donations_7d));
    } else {
      // If no data available, show empty
      this.updateElement('donations-7d', '0.000');
    }
  }

  // Load and display projects
  async loadProjects() {
    try {
      const categoryFilter = document.getElementById('category-filter');
      const statusFilter = document.getElementById('status-filter');
      
      const params = new URLSearchParams();
      if (categoryFilter && categoryFilter.value) {
        params.append('category', categoryFilter.value);
      }
      if (statusFilter && statusFilter.value) {
        params.append('status', statusFilter.value);
      }
      params.append('limit', '50');
      
      const projects = await this.fetchJSON(`/projects?${params}`);
      const votes = await this.fetchJSON('/votes/priority/summary');
      
      console.log('Dashboard projects:', projects.length);
      console.log('Dashboard votes data:', votes);
      console.log('Dashboard votes length:', votes ? votes.length : 0);
      
      this.displayProjects(projects, votes);
      
    } catch (error) {
      console.error('Failed to load projects:', error);
    }
  }

  // Display projects in the dashboard section table
  displayProjects(projects, votes) {
    const tbody = document.getElementById('projects-tbody');
    if (!tbody) return;
    
    // Create vote lookup
    const votesById = {};
    if (votes && votes.length > 0) {
      votes.forEach(vote => {
        votesById[vote.project_id] = vote;
      });
    }
    
    tbody.innerHTML = '';
    
    if (projects.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">' + i18n.t('projects.no_projects_found') + '</td></tr>';
      return;
    }
    
    projects.forEach(project => {
      const vote = votesById[project.id] || {
        for_weight: 0,
        against_weight: 0,
        abstained_count: 0,
        not_participating_count: 0,
        turnout_percentage: 0
      };
      
      const progressPercent = (project.total_allocated / project.target * 100).toFixed(1);
      const lacking = Math.max(0, project.target - project.total_allocated);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div><strong><a href="#" onclick="app.viewProject('${project.id}'); return false;" style="text-decoration: none; color: #007bff;">${this.escapeHtml(project.name)}</a></strong></div>
          <div class="text-muted" style="font-size: 0.875rem;">${this.escapeHtml(project.category)}</div>
          <span class="badge badge-${this.getStatusBadgeClass(project.status)}">${project.status}</span>
        </td>
        <td class="text-center">${project.priority || '-'}</td>
        <td>
          <div class="mb-1">${this.formatETH(project.total_allocated)} / ${this.formatETH(project.target)} ETH</div>
          <div class="progress">
            <div class="progress-bar" style="width: ${Math.min(100, progressPercent)}%"></div>
          </div>
          <div class="text-muted" style="font-size: 0.75rem;">${progressPercent}%</div>
        </td>
        <td class="text-right">${this.formatETH(lacking)} ETH</td>
        <td class="text-center">
          <div class="vote-results">
            <span class="badge badge-success" title="For">${vote.for_weight}</span>
            <span class="badge badge-danger" title="Against">${vote.against_weight}</span>
            <span class="badge badge-info" title="Abstain">${vote.abstained_count}</span>
            <span class="badge badge-secondary" title="Not Participating">${vote.not_participating_count}</span>
          </div>
          <div class="text-muted" style="font-size: 0.75rem;">Turnout: ${vote.turnout_percentage}%</div>
        </td>
        <td class="text-center">
          ${this.calculateETA(project)}
        </td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="app.supportProject('${project.id}')">${i18n.t('buttons.support')}</button>
          <button class="btn btn-secondary btn-sm ml-2" onclick="app.viewProject('${project.id}')">${i18n.t('buttons.details')}</button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // Projects section functions
  async loadProjectsSection() {
    try {
      // Load projects with filters for main projects section
      await this.loadProjectsMain();
      
      // Load and populate filter options
      this.populateProjectFilters();
      
      // Set up filter event listeners
      this.setupProjectFilters();
      
    } catch (error) {
      console.error('Failed to load projects section:', error);
    }
  }

  // Load and display projects in main projects section
  async loadProjectsMain() {
    try {
      const categoryFilter = document.getElementById('project-category-filter');
      const statusFilter = document.getElementById('project-status-filter');
      
      const params = new URLSearchParams();
      if (categoryFilter && categoryFilter.value) {
        params.append('category', categoryFilter.value);
      }
      if (statusFilter && statusFilter.value) {
        params.append('status', statusFilter.value);
      }
      params.append('limit', '50');
      
      const projects = await this.fetchJSON(`/projects?${params}`);
      const votes = await this.fetchJSON('/votes/priority/summary');
      
      this.displayProjectsMain(projects, votes);
      
    } catch (error) {
      console.error('Failed to load projects for main section:', error);
    }
  }

  // Display projects in the main projects section table
  displayProjectsMain(projects, votes) {
    const tbody = document.getElementById('projects-main-tbody');
    if (!tbody) return;
    
    // Create vote lookup
    const votesById = {};
    if (votes && votes.length > 0) {
      votes.forEach(vote => {
        votesById[vote.project_id] = vote;
      });
    }
    
    tbody.innerHTML = '';
    
    if (projects.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">' + i18n.t('projects.no_projects_found') + '</td></tr>';
      return;
    }
    
    projects.forEach(project => {
      const vote = votesById[project.id] || {
        for_weight: 0,
        against_weight: 0,
        abstained_count: 0,
        not_participating_count: 0,
        turnout_percentage: 0
      };
      
      const progressPercent = (project.total_allocated / project.target * 100).toFixed(1);
      const lacking = Math.max(0, project.target - project.total_allocated);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div><strong><a href="#" onclick="app.viewProject('${project.id}'); return false;" style="text-decoration: none; color: #007bff;">${this.escapeHtml(project.name)}</a></strong></div>
          <div class="text-muted" style="font-size: 0.875rem;">${this.escapeHtml(project.category)}</div>
          <span class="badge badge-${this.getStatusBadgeClass(project.status)}">${project.status}</span>
        </td>
        <td class="text-center">${project.priority || '-'}</td>
        <td>
          <div class="mb-1">${this.formatETH(project.total_allocated)} / ${this.formatETH(project.target)} ETH</div>
          <div class="progress">
            <div class="progress-bar" style="width: ${Math.min(100, progressPercent)}%"></div>
          </div>
          <div class="text-muted" style="font-size: 0.75rem;">${progressPercent}%</div>
        </td>
        <td class="text-right">${this.formatETH(lacking)} ETH</td>
        <td class="text-center">
          <div class="vote-results">
            <span class="badge badge-success" title="For">${vote.for_weight}</span>
            <span class="badge badge-danger" title="Against">${vote.against_weight}</span>
            <span class="badge badge-info" title="Abstain">${vote.abstained_count}</span>
            <span class="badge badge-secondary" title="Not Participating">${vote.not_participating_count}</span>
          </div>
          <div class="text-muted" style="font-size: 0.75rem;">Turnout: ${vote.turnout_percentage}%</div>
        </td>
        <td class="text-center">
          ${this.calculateETA(project)}
        </td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="app.supportProject('${project.id}')">${i18n.t('buttons.support')}</button>
          <button class="btn btn-secondary btn-sm ml-2" onclick="app.viewProject('${project.id}')">${i18n.t('buttons.details')}</button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // Populate projects category/status filter dropdown options
  populateProjectFilters() {
    // Project category filters
    this.populateFilter(
      '/stats/category_options',
      document.getElementById('project-category-filter')
    );

    // Project status filters
    this.populateFilter(
      '/stats/status_options',
      document.getElementById('project-status-filter')
    );
  }

  // Populate a select input dropdown based on filter JSON API results
  populateFilter(endpoint, el) {
    el.innerHTML = '';

    // Add 'any' default filter
    const any = document.createElement('option');
    any.setAttribute('value', '');
    any.textContent = 'Any';
    el.appendChild(any);
    
    this.fetchJSON(endpoint)
      .then(values => {
        values.forEach(val => {
          const opt = document.createElement('option');
          opt.setAttribute('value', val.key);
          opt.textContent = val.title;
          el.appendChild(opt);
        });
      });
  }

  // Load project when the row/project table button is clicked
  viewProject(project_id) {
    this.loadProjectDetail(project_id);
  }

  // Load project details view (not for use within modals, since load modal doesn't rebind scripts and causes js failures on view update)
  async loadProjectDetail(project_id) {
    try {
      const projectData = await this.fetchJSON(`/projects/${project_id}/json`);

      await app.views('appProjectOverview.load')(project_id, projectData);
      
      // Set project info variables based on project info json, set as local
      const projectInfoDivs = {};
      (Array).forEach.call(document.querySelectorAll('[data-project-info]'), function(el) {
        const key = el.getAttribute('data-project-info');
        projectInfoDivs[key] = el;
      });

      Object.keys(projectInfoDivs).forEach(key => {
        projectInfoDivs[key].textContent = projectData[key];
      });

      // Set project detail variables based on project detail json, set as local
      const projectDetailDivs = {};
      (Array).forEach.call(document.querySelectorAll('[data-project-detail]'), function(el) {
        const key = el.getAttribute('data-project-detail');
        projectDetailDivs[key] = el;
      });

      Object.keys(projectDetailDivs).forEach(key => {
        projectDetailDivs[key].textContent = projectData[key];
      });

      // Update project detail stats
      this.updateProjectDetailStats(projectData);

      // Update project detail votes
      this.updateProjectDetailVotes(projectData);

      // Update project detail status
      this.updateProjectDetailStatus(projectData);

      // Update project detail actions
      this.updateProjectDetailActions(projectData);

      // Show project detail view
      this.showView('project-detail');

    } catch (error) {
      console.error('Failed to load project detail:', error);
    }
  }

  // Update project detail stats
  updateProjectDetailStats(projectData) {
    this.updateElement('project-detail-stats-total-allocated', this.formatETH(projectData.total_allocated));
    this.updateElement('project-detail-stats-total-paid-out', this.formatETH(projectData.total_paid_out));
    this.updateElement('project-detail-stats-total-balance', this.formatETH(projectData.total_balance));
    this.updateElement('project-detail-stats-status', projectData.status);
    this.updateElement('project-detail-stats-progress', (projectData.total_allocated / projectData.target * 100).toFixed(1) + '%');
    this.updateElement('project-detail-stats-lacking', this.formatETH(projectData.target - projectData.total_allocated));
    this.updateElement('project-detail-stats-votes-for', projectData.votes_for);
    this.updateElement('project-detail-stats-votes-against', projectData.votes_against);
    this.updateElement('project-detail-stats-votes-abstain', projectData.votes_abstain);
    this.updateElement('project-detail-stats-votes-not-participating', projectData.votes_not_participating);
    this.updateElement('project-detail-stats-votes-turnout', projectData.votes_turnout_percentage + '%');
  }

  // Update project detail votes
  updateProjectDetailVotes(projectData) {
    this.updateElement('project-detail-votes-for', projectData.votes_for);
    this.updateElement('project-detail-votes-against', projectData.votes_against);
    this.updateElement('project-detail-votes-abstain', projectData.votes_abstain);
    this.updateElement('project-detail-votes-not-participating', projectData.votes_not_participating);
    this.updateElement('project-detail-votes-turnout', projectData.votes_turnout_percentage + '%');
  }

  // Update project detail status
  updateProjectDetailStatus(projectData) {
    const status = projectData.status;
    const statusText = document.getElementById('project-detail-status-text');
    const statusBadge = document.getElementById('project-detail-status-badge');

    statusText.textContent = status;
    statusBadge.className = `badge badge-${this.getStatusBadgeClass(status)}`;
  }

  // Update project detail actions
  updateProjectDetailActions(projectData) {
    if (projectData.can_support) {
      document.getElementById('project-detail-action-support').style.display = 'inline-block';
    } else {
      document.getElementById('project-detail-action-support').style.display = 'none';
    }

    if (projectData.can_approve) {
      document.getElementById('project-detail-action-approve').style.display = 'inline-block';
    } else {
      document.getElementById('project-detail-action-approve').style.display = 'none';
    }

    if (projectData.can_reject) {
      document.getElementById('project-detail-action-reject').style.display = 'inline-block';
    } else {
      document.getElementById('project-detail-action-reject').style.display = 'none';
    }
  }

  // Support project when the project detail support button is clicked
  supportProject(project_id) {
    this.supportProjectById(project_id);
  }

  // Support project by ID
  async supportProjectById(project_id) {
    try {
      const result = await this.fetchJSON('/projects/' + project_id + '/support', 'POST');

      if (result.success) {
        await this.loadProjectDetail(project_id);
        this.showView('project-detail');
      }

    } catch (error) {
      console.error('Failed to support project:', error);
    }
  }

  // Approve project when the project detail approve button is clicked
  approveProject(project_id) {
    this.approveProjectById(project_id);
  }

  // Approve project by ID
  async approveProjectById(project_id) {
    try {
      const result = await this.fetchJSON('/projects/' + project_id + '/approve', 'POST');

      if (result.success) {
        await this.loadProjectDetail(project_id);
        this.showView('project-detail');
      }

    } catch (error) {
      console.error('Failed to approve project:', error);
    }
  }

  // Reject project when the project detail reject button is clicked
  rejectProject(project_id) {
    this.rejectProjectById(project_id);
  }

  // Reject project by ID
  async rejectProjectById(project_id) {
    try {
      const result = await this.fetchJSON('/projects/' + project_id + '/reject', 'POST');

      if (result.success) {
        await this.loadProjectDetail(project_id);
        this.showView('project-detail');
      }

    } catch (error) {
      console.error('Failed to reject project:', error);
    }
  }

  // Utility functions
  async fetchJSON(url, method = 'GET', data = {}) {
    const options = {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
    };

    if (method !== 'GET') {
      options.body = JSON.stringify(data);
    }

    const res = await fetch(url, options);

    if (!res.ok) {
      throw new Error('Network response was not ok');
    }

    return await res.json();
  }

  escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  formatETH(value) {
    if (value === undefined || value === null) {
      return '0.000';
    }
    return parseFloat(value).toFixed(3);
  }

  getStatusBadgeClass(status) {
    return 'success';
  }

  calculateETA(project) {
    return 'TBD';
  }

  updateElement(id, value) {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = value;
    }
    
    projects.forEach(project => {
      const vote = votesById[project.id] || {
        for_weight: 0,
        against_weight: 0,
        abstained_count: 0,
        not_participating_count: 0,
        turnout_percentage: 0
      };
      
      const progressPercent = (project.total_allocated / project.target * 100).toFixed(1);
      const lacking = Math.max(0, project.target - project.total_allocated);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div><strong><a href="#" onclick="app.viewProject('${project.id}'); return false;" style="text-decoration: none; color: #007bff;">${this.escapeHtml(project.name)}</a></strong></div>
          <div class="text-muted" style="font-size: 0.875rem;">${this.escapeHtml(project.category)}</div>
          <span class="badge badge-${this.getStatusBadgeClass(project.status)}">${project.status}</span>
        </td>
        <td class="text-center">${project.priority || '-'}</td>
        <td>
          <div class="mb-1">${this.formatETH(project.total_allocated)} / ${this.formatETH(project.target)} ETH</div>
          <div class="progress">
            <div class="progress-bar" style="width: ${Math.min(100, progressPercent)}%"></div>
          </div>
          <div class="text-muted" style="font-size: 0.75rem;">${progressPercent}%</div>
        </td>
        <td class="text-right">${this.formatETH(lacking)} ETH</td>
        <td class="text-center">
          <div class="vote-results">
            <span class="badge badge-success" title="For">${vote.for_weight}</span>
            <span class="badge badge-danger" title="Against">${vote.against_weight}</span>
            <span class="badge badge-info" title="Abstain">${vote.abstained_count}</span>
            <span class="badge badge-secondary" title="Not Participating">${vote.not_participating_count}</span>
          </div>
          <div class="text-muted" style="font-size: 0.75rem;">Turnout: ${vote.turnout_percentage}%</div>
        </td>
        <td class="text-center">
          ${this.calculateETA(project)}
        </td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="app.supportProject('${project.id}')">${i18n.t('buttons.support')}</button>
          <button class="btn btn-secondary btn-sm ml-2" onclick="app.viewProject('${project.id}')">${i18n.t('buttons.details')}</button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // Populate project filter options
  populateProjectFilters() {
    const categoryFilter = document.getElementById('project-category-filter');
    const statusFilter = document.getElementById('project-status-filter');
    
    if (categoryFilter) {
      // Clear existing options
      categoryFilter.innerHTML = `<option value="">${i18n.t('filters.all_categories')}</option>`;
      
      // Try to fetch categories from API
      this.fetchJSON('/stats/categories')
        .then(response => {
          if (response && response.data && response.data.length > 0) {
            response.data.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat.category;
              option.textContent = cat.category;
              categoryFilter.appendChild(option);
            });
          }
        })
        .catch(error => {
          console.error('Failed to fetch categories:', error);
          // Show error message
          this.showError(i18n.t('admin_modals.messages.failed_to_load_categories'));
        });
    }
    
    if (statusFilter) {
      // Clear existing options
      statusFilter.innerHTML = '<option value="">' + i18n.t('filters.all_status') + '</option>';
      
      // Add common statuses
      const statuses = ['active', 'voting', 'ready_to_payout', 'paid', 'cancelled'];
      statuses.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status.replace('_', ' ').toUpperCase();
        statusFilter.appendChild(option);
      });
    }
  }

  // Set up project filter event listeners
  setupProjectFilters() {
    const categoryFilter = document.getElementById('project-category-filter');
    const statusFilter = document.getElementById('project-status-filter');
    const periodFilter = document.getElementById('project-period-filter');
    
    [categoryFilter, statusFilter, periodFilter].forEach(filter => {
      if (filter) {
        filter.addEventListener('change', () => {
          // Reload projects for the current section
          if (this.currentSection === 'projects') {
            this.loadProjectsMain();
          } else {
            this.loadProjects();
          }
        });
      }
    });
  }

  // Voting section functions
  async loadVotingSection() {
    try {
      // Force update translations when loading voting section
      if (window.i18n && typeof window.i18n.applyTranslations === 'function') {
        window.i18n.applyTranslations();
      }
      
      // Load current voting round info
      const currentRound = await this.fetchJSON('/votes/current-round');
      
      console.log('Voting round data received:', currentRound);
      
      // Check if there's actually an active round with valid data
      if (currentRound && 
          currentRound.round_id && 
          currentRound.round_id !== 'N/A' && 
          currentRound.round_id !== '--' &&
          currentRound.phase && 
          currentRound.phase !== 'no_active_round' &&
          currentRound.phase !== 'N/A' &&
          currentRound.phase !== '--') {
        // Display current round information
        this.displayCurrentVotingRound(currentRound);
        
        // Load voting results
        const votingResults = await this.fetchJSON('/votes/priority/summary');
        // Display voting results
        this.displayVotingResults(votingResults);
        
        // Start voting timer if in active phase
        if (currentRound.phase === 'commit' || currentRound.phase === 'reveal') {
          this.startVotingTimer(currentRound);
        }
      } else {
        // No active round - show appropriate message
        this.displayNoActiveRound();
      }
      
    } catch (error) {
      console.error('Failed to load voting section:', error);
      // Show no active round instead of error
      this.displayNoActiveRound();
    }
  }

  // Display current voting round information
  displayCurrentVotingRound(roundInfo) {
    // Validate round info before displaying
    if (!roundInfo || !roundInfo.round_id) {
      this.displayNoActiveRound();
      return;
    }

    this.updateElement('current-round', roundInfo.round_id);
    this.updateElement('voting-phase', this.getPhaseDisplayName(roundInfo.phase));
    this.updateElement('total-participants', roundInfo.total_participants || 0);
    this.updateElement('total-revealed', roundInfo.total_revealed || 0);
    this.updateElement('turnout-percentage', `${(roundInfo.turnout_percentage || 0).toFixed(1)}%`);
    this.updateElement('voting-method', this.getMethodDisplayName(roundInfo.counting_method) || 'взвешенное');

    // Update voting controls based on phase
    this.updateVotingControls(roundInfo);
    
    // Update project list for voting
    if (roundInfo.projects && roundInfo.projects.length > 0) {
      this.displayVotingProjects(roundInfo.projects, roundInfo.phase);
    } else {
      // No projects in round
      const tbody = document.getElementById('voting-projects-tbody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Нет проектов в текущем раунде голосования</td></tr>';
      }
    }
  }

  // Display no active round state
  displayNoActiveRound() {
    console.log('Displaying no active round state');
    
    this.updateElement('current-round', 'Нет');
    this.updateElement('voting-phase', 'Нет активного раунда');
    this.updateElement('total-participants', '0');
    this.updateElement('total-revealed', '0');
    this.updateElement('turnout-percentage', '0.0%');
    this.updateElement('voting-method', 'взвешенное');

    // Hide all voting sections
    const commitSection = document.getElementById('commit-voting-section');
    const revealSection = document.getElementById('reveal-voting-section');
    const votingComplete = document.getElementById('voting-complete-section');
    
    [commitSection, revealSection, votingComplete].forEach(section => {
      if (section) section.classList.add('hidden');
    });

    // Clear voting projects table
    const tbody = document.getElementById('voting-projects-tbody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Нет активного раунда голосования</td></tr>';
    }

    // Clear voting results table
    const resultsTbody = document.getElementById('voting-results-tbody');
    if (resultsTbody) {
      resultsTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Нет результатов голосования</td></tr>';
    }

    // Stop any running timer
    if (this.votingTimer) {
      clearInterval(this.votingTimer);
      this.votingTimer = null;
    }
  }

  // Get display name for voting phase
  getPhaseDisplayName(phase) {
    const phaseNames = {
      'pending': 'Не начат',
      'commit': 'Фаза фиксации',
      'reveal': 'Фаза раскрытия',
      'pending_finalization': 'Ожидает финализации',
      'finalized': 'Завершен',
      'ended': 'Окончен',
      'no_active_round': 'Нет активного раунда'
    };
    return phaseNames[phase] || phase;
  }

  // Get display name for voting method
  getMethodDisplayName(method) {
    const methodNames = {
      'weighted': 'взвешенное',
      'borda': 'метод Борда',
      'simple': 'простое',
      'plurality': 'множественное'
    };
    return methodNames[method] || method;
  }

  // Update voting controls based on current phase
  updateVotingControls(roundInfo) {
    const commitSection = document.getElementById('commit-voting-section');
    const revealSection = document.getElementById('reveal-voting-section');
    const votingComplete = document.getElementById('voting-complete-section');
    
    // Hide all sections first
    [commitSection, revealSection, votingComplete].forEach(section => {
      if (section) section.classList.add('hidden');
    });

    // Show appropriate section based on phase
    if (roundInfo.phase === 'commit' && commitSection) {
      commitSection.classList.remove('hidden');
      this.setupCommitInterface(roundInfo);
    } else if (roundInfo.phase === 'reveal' && revealSection) {
      revealSection.classList.remove('hidden');
      this.setupRevealInterface(roundInfo);
    } else if ((roundInfo.phase === 'finalized' || roundInfo.phase === 'ended') && votingComplete) {
      votingComplete.classList.remove('hidden');
    }
  }

  // Setup commit interface
  setupCommitInterface(roundInfo) {
    const form = document.getElementById('commit-vote-form');
    if (!form) return;

    // Clear existing form
    form.innerHTML = '';
    
    // Check if user has already voted in this round
    const votingStatus = this.checkUserVotingStatus(roundInfo.round_id);
    
    if (votingStatus.hasCommitted) {
      // Show "already voted" message instead of voting form
      const alreadyVotedDiv = document.createElement('div');
      alreadyVotedDiv.className = 'alert alert-success text-center';
      alreadyVotedDiv.innerHTML = `
        <h5><i class="fas fa-check-circle"></i> ${i18n.t('voting.commit_phase.already_voted')}</h5>
        <p>${i18n.t('voting.commit_phase.vote_confirmed', {round_id: roundInfo.round_id})}</p>
        <p class="mb-0">${i18n.t('voting.commit_phase.wait_for_reveal')}</p>
      `;
      form.appendChild(alreadyVotedDiv);
      return;
    }
    
    // Add instructions
    const instructions = document.createElement('div');
    instructions.className = 'alert alert-info mb-3';
    instructions.innerHTML = `
      <h6>${i18n.t('voting.commit_phase.instructions_title')}</h6>
      <p>${i18n.t('voting.commit_phase.instructions_text1')}</p>
      <p>${i18n.t('voting.commit_phase.instructions_text2')}</p>
    `;
    form.appendChild(instructions);

    // Add project voting controls
    if (roundInfo.projects) {
      roundInfo.projects.forEach((project, index) => {
        const projectVoteDiv = this.createProjectVoteControl(project, index);
        form.appendChild(projectVoteDiv);
      });
    }

    // Add salt input
    const saltDiv = document.createElement('div');
    saltDiv.className = 'form-group mt-3';
    saltDiv.innerHTML = `
      <label for="vote-salt">${i18n.t('voting.commit_phase.secret_salt_label')}</label>
      <input type="text" class="form-control" id="vote-salt" 
             value="${this.generateRandomSalt()}" readonly>
      <small class="form-text text-muted">
        ${i18n.t('voting.commit_phase.salt_description')}
      </small>
    `;
    form.appendChild(saltDiv);

    // Add submit button
    const submitDiv = document.createElement('div');
    submitDiv.className = 'text-center mt-4';
    submitDiv.innerHTML = `
      <button type="button" class="btn btn-primary btn-lg" onclick="app.submitCommitVote(${roundInfo.round_id})">
        ${i18n.t('voting.commit_phase.submit_button')}
      </button>
    `;
    form.appendChild(submitDiv);
  }

  // Create project vote control
  createProjectVoteControl(project, index) {
    const div = document.createElement('div');
    div.className = 'card mb-3';
    div.innerHTML = `
      <div class="card-body">
        <h6 class="card-title">${this.escapeHtml(project.name)}</h6>
        <p class="card-text text-muted">${this.escapeHtml(project.description.substring(0, 100))}...</p>
        <div class="form-group">
          <label>${i18n.t('voting.commit_phase.your_vote')}</label>
          <div class="btn-group btn-group-toggle d-block" data-toggle="buttons">
            <label class="btn btn-outline-success">
              <input type="radio" name="vote-${project.id}" value="for"> ${i18n.t('voting.commit_phase.for')}
            </label>
            <label class="btn btn-outline-danger">
              <input type="radio" name="vote-${project.id}" value="against"> ${i18n.t('voting.commit_phase.against')}
            </label>
            <label class="btn btn-outline-info">
              <input type="radio" name="vote-${project.id}" value="abstain"> ${i18n.t('voting.commit_phase.abstain')}
            </label>
            <label class="btn btn-outline-secondary active">
              <input type="radio" name="vote-${project.id}" value="not_participating" checked> ${i18n.t('voting.commit_phase.not_participating')}
            </label>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-sm-6">
            <small class="text-muted">${i18n.t('voting.commit_phase.target')}: ${this.formatETH(project.target)} ETH</small>
          </div>
          <div class="col-sm-6">
            <small class="text-muted">${i18n.t('voting.commit_phase.allocated')}: ${this.formatETH(project.total_allocated)} ETH</small>
          </div>
        </div>
      </div>
    `;
    return div;
  }

  // Setup reveal interface
  setupRevealInterface(roundInfo) {
    const form = document.getElementById('reveal-vote-form');
    if (!form) return;

    // Check if user has vote data to reveal
    const votingStatus = this.checkUserVotingStatus(roundInfo.round_id);
    
    if (votingStatus.hasRevealed) {
      // User has already revealed votes
      form.innerHTML = `
        <div class="alert alert-success text-center">
          <h5><i class="fas fa-check-circle"></i> ${i18n.t('voting.reveal_phase.already_revealed')}</h5>
          <p>${i18n.t('voting.reveal_phase.votes_confirmed', {round_id: roundInfo.round_id})}</p>
          <p class="mb-0">${i18n.t('voting.reveal_phase.wait_for_results')}</p>
        </div>
      `;
      return;
    }
    
    if (!votingStatus.hasCommitted) {
      // User hasn't committed a vote
      form.innerHTML = `
        <div class="alert alert-warning text-center">
          <h5><i class="fas fa-exclamation-triangle"></i> ${i18n.t('voting.reveal_phase.no_votes_to_reveal')}</h5>
          <p>${i18n.t('voting.reveal_phase.no_committed_votes')}</p>
          <p class="mb-0">${i18n.t('voting.reveal_phase.wait_for_next_round')}</p>
        </div>
      `;
      return;
    }

    form.innerHTML = `
      <div class="alert alert-warning mb-3">
        <h6>${i18n.t('voting.reveal_phase.title')}</h6>
        <p>${i18n.t('voting.reveal_phase.instructions_text1')}</p>
        <p><strong>${i18n.t('voting.reveal_phase.warning')}</strong> ${i18n.t('voting.reveal_phase.warning_text')}</p>
      </div>
      <div class="form-group">
        <label for="reveal-salt">${i18n.t('voting.reveal_phase.salt_label')}</label>
        <input type="text" class="form-control" id="reveal-salt" 
               placeholder="${i18n.t('voting.reveal_phase.salt_placeholder')}">
      </div>
      <div id="reveal-votes-summary" class="mt-3">
        <h6>${i18n.t('voting.reveal_phase.committed_votes_title')}</h6>
        <p class="text-muted">${i18n.t('voting.reveal_phase.committed_votes_text')}</p>
      </div>
      <div class="text-center mt-4">
        <button type="button" class="btn btn-success btn-lg" onclick="app.submitRevealVote(${roundInfo.round_id})">
          ${i18n.t('voting.reveal_phase.reveal_button')}
        </button>
      </div>
    `;
  }

  // Display voting projects in the main voting table
  displayVotingProjects(projects, phase) {
    const tbody = document.getElementById('voting-projects-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!projects || projects.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Нет проектов в текущем раунде голосования</td></tr>';
      return;
    }
    
    // Get voting results for current projects
    this.fetchJSON('/votes/priority/summary')
      .then(votingResults => {
        // Create vote lookup
        const votesById = {};
        if (votingResults && votingResults.length > 0) {
          votingResults.forEach(vote => {
            votesById[vote.project_id] = vote;
          });
        }
        
        projects.forEach(project => {
          const vote = votesById[project.id] || {
            for_weight: 0,
            against_weight: 0,
            abstained_count: 0,
            not_participating_count: 0,
            turnout_percentage: 0
          };
          
          const progressPercent = (project.total_allocated / project.target * 100).toFixed(1);
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <div><strong><a href="#" onclick="app.viewProject('${project.id}'); return false;" style="text-decoration: none; color: #007bff;">${this.escapeHtml(project.name)}</a></strong></div>
              <div class="text-muted" style="font-size: 0.875rem;">${this.escapeHtml(project.category)}</div>
            </td>
            <td>
              <div class="mb-1">${this.formatETH(project.total_allocated)} / ${this.formatETH(project.target)} ETH</div>
              <div class="progress">
                <div class="progress-bar" style="width: ${Math.min(100, progressPercent)}%"></div>
              </div>
              <div class="text-muted" style="font-size: 0.75rem;">${progressPercent}%</div>
            </td>
            <td class="text-center">
              <span class="badge badge-info">${phase}</span>
            </td>
            <td class="text-center">
              <div class="vote-results">
                <span class="badge badge-success" title="${i18n.t('table.for')}">${vote.for_weight}</span>
                <span class="badge badge-danger" title="${i18n.t('table.against')}">${vote.against_weight}</span>
                <span class="badge badge-info" title="${i18n.t('table.abstain')}">${vote.abstained_count}</span>
                <span class="badge badge-secondary" title="${i18n.t('table.not_participating')}">${vote.not_participating_count}</span>
              </div>
              <div class="text-muted" style="font-size: 0.75rem;">${i18n.t('table.turnout')}: ${vote.turnout_percentage}%</div>
            </td>
            <td>
              <button class="btn btn-info btn-sm" onclick="app.viewProject('${project.id}')">
                ${i18n.t('buttons.details')}
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error loading voting results for projects:', error);
        // Fallback without voting results
        projects.forEach(project => {
          const progressPercent = (project.total_allocated / project.target * 100).toFixed(1);
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <div><strong><a href="#" onclick="app.viewProject('${project.id}'); return false;" style="text-decoration: none; color: #007bff;">${this.escapeHtml(project.name)}</a></strong></div>
              <div class="text-muted" style="font-size: 0.875rem;">${this.escapeHtml(project.category)}</div>
            </td>
            <td>
              <div class="mb-1">${this.formatETH(project.total_allocated)} / ${this.formatETH(project.target)} ETH</div>
              <div class="progress">
                <div class="progress-bar" style="width: ${Math.min(100, progressPercent)}%"></div>
              </div>
              <div class="text-muted" style="font-size: 0.75rem;">${progressPercent}%</div>
            </td>
            <td class="text-center">
              <span class="badge badge-info">${phase}</span>
            </td>
            <td class="text-center">
              <div class="text-muted">${i18n.t('voting.waiting_for_results')}</div>
            </td>
            <td>
              <button class="btn btn-info btn-sm" onclick="app.viewProject('${project.id}')">
                ${i18n.t('buttons.details')}
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      });
  }

  // Display voting results
  displayVotingResults(results) {
    const tbody = document.getElementById('voting-results-tbody');
    if (!tbody) {
      console.error('voting-results-tbody element not found');
      return;
    }
    
    tbody.innerHTML = '';
    
    if (!results || results.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Нет результатов голосования</td></tr>`;
      return;
    }
    
    results.forEach((result, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${result.project_id ? result.project_id.substring(0, 8) + '...' : 'Неизвестно'}</td>
        <td class="text-center">
          <span class="badge badge-success">${result.for_weight || 0}</span>
        </td>
        <td class="text-center">
          <span class="badge badge-danger">${result.against_weight || 0}</span>
        </td>
        <td class="text-center">
          <span class="badge badge-info">${result.abstained_count || 0}</span>
        </td>
        <td class="text-center">
          <span class="badge badge-secondary">${result.not_participating_count || 0}</span>
        </td>
        <td class="text-center">${result.turnout_percentage || 0}%</td>
        <td class="text-center">
          <strong>${result.final_priority || (index + 1)}</strong>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // Treasury section functions
  async loadTreasurySection() {
    try {
      const stats = await this.fetchJSON('/treasury/stats');
      this.updateTreasuryMetrics(stats);
      
      // Load recent transactions
      const transactions = await this.fetchJSON('/treasury/transactions?limit=50');
      this.displayTreasuryTransactions(transactions);
      
    } catch (error) {
      console.error('Failed to load treasury section:', error);
    }
  }

  

  // Personal stats functions
  async loadPersonalStats() {
    try {
      const walletInput = document.getElementById('wallet-address');
      const address = walletInput ? walletInput.value.trim() : this.walletAddress;
      
      if (!address) {
        this.showError(i18n.t('admin_modals.messages.please_enter_wallet_address'));
        return;
      }
      
      this.walletAddress = address;
      
      const params = new URLSearchParams();
      params.append('user_address', address);
      
      // Use special API call that doesn't show generic error for "User not found"
      const stats = await this.fetchJSONSilent(`/me/stats?${params}`);
      this.displayPersonalStats(stats);
      
      // Show the stats content
      const statsContent = document.getElementById('personal-stats-content');
      if (statsContent) {
        statsContent.classList.remove('hidden');
      }
      
    } catch (error) {
      console.error('Failed to load personal stats:', error);
      
      // Check if it's a "User not found" error (404 with specific message)
      if (error.message && error.message.includes('404') && 
          (error.message.includes('User not found') || 
           (this.lastResponse && this.lastResponse.detail === 'User not found'))) {
        this.showError(i18n.t('admin_modals.messages.user_not_found'));
      } else {
        this.showError(i18n.t('admin_modals.messages.failed_to_load_personal_stats'));
      }
    }
  }

  // Display personal statistics
  displayPersonalStats(stats) {
    this.updateElement('my-total-donated', this.formatETH(stats.total_donated));
    this.updateElement('my-projects-count', stats.supported_projects);
    this.updateElement('my-avg-share', `${stats.average_share_percentile}%`);
    
    // Update comparisons
    this.updateElement('donation-percentile', `${stats.average_share_percentile}th percentile`);
    this.updateElement('projects-comparison', `Above average`);
    this.updateElement('share-percentile', `${stats.average_share_percentile}th percentile`);
    
    // Display allocations
    this.displayPersonalAllocations(stats.allocations);
  }

  // Display personal allocations
  displayPersonalAllocations(allocations) {
    const container = document.getElementById('my-allocations');
    if (!container) return;
    
    if (!allocations || allocations.length === 0) {
      container.innerHTML = `<div class="text-center text-muted">${i18n.t('personal.allocations_not_found')}</div>`;
      return;
    }
    
    let html = `<div class="table-responsive"><table class="table"><thead><tr><th>${i18n.t('personal.project')}</th><th>${i18n.t('personal.amount')}</th><th>${i18n.t('personal.share')}</th></tr></thead><tbody>`;
    
    allocations.forEach(allocation => {
      html += `
        <tr>
          <td>${allocation.project_id ? allocation.project_id.substring(0, 8) + '...' : 'Неизвестно'}</td>
          <td>${this.formatETH(allocation.amount)} ETH</td>
          <td>${allocation.share_percentage || 0}%</td>
        </tr>
      `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  // Admin section functions
  async loadAdminSection() {
    try {
      // Load indexer status
      const indexerStatus = await this.fetchJSON('/admin/indexer/status');
      this.updateIndexerStatus(indexerStatus);
      
    } catch (error) {
      console.error('Failed to load admin section:', error);
    }
  }

  // Update indexer status
  updateIndexerStatus(status) {
    const container = document.getElementById('indexer-status');
    if (!container) return;
    
    const statusClass = status.running ? 'badge-success' : 'badge-danger';
    const statusText = status.running ? i18n.t('admin.indexer_running') : i18n.t('admin.indexer_stopped');
    
    container.innerHTML = `
      <div>${i18n.t('admin.indexer_status')}: <span class="badge ${statusClass}">${statusText}</span></div>
      <div class="text-muted">${i18n.t('admin.contracts')}: ${status.contracts && status.contracts.length > 0 ? status.contracts.join(', ') : i18n.t('admin.no_contracts')}</div>
      <div class="text-muted">${i18n.t('admin.poll_interval')}: ${status.poll_interval || 0}s</div>
    `;
  }

  // Utility functions
  updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = value;
    }
  }

  formatETH(value) {
    if (typeof value !== 'number' || isNaN(value)) return '0.000';
    return value.toFixed(3);
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  getStatusBadgeClass(status) {
    const statusClasses = {
      'active': 'info',
      'voting': 'warning',
      'ready_to_payout': 'success',
      'paid': 'secondary',
      'cancelled': 'danger'
    };
    return statusClasses[status] || 'info';
  }

  calculateETA(project) {
    if (project.total_allocated >= project.target) {
      return '<span class="badge badge-success">Target Reached</span>';
    }
    
    // Try to calculate ETA based on recent donation rate if available
    if (project.donation_rate_7d > 0) {
      const remaining = project.target - project.total_allocated;
      if (remaining > 0) {
        const daysToCompletion = remaining / project.donation_rate_7d;
        if (daysToCompletion <= 1) {
          return '<span class="badge badge-warning">Soon</span>';
        } else if (daysToCompletion <= 7) {
          return `<span class="badge badge-info">${Math.ceil(daysToCompletion)} days</span>`;
        } else {
          return `<span class="text-muted">${Math.ceil(daysToCompletion)} days</span>`;
        }
      }
    }
    
    // If no rate data available, show empty
    return '<span class="text-muted">Недоступно</span>';
  }

  showError(message) {
    console.error(message);
    // Try to show in modal first, then fallback to alert
    try {
      const modal = document.getElementById('admin-modal');
      if (modal && !modal.classList.contains('hidden')) {
        // Show error in current modal
        const modalBody = document.getElementById('modal-body');
        if (modalBody) {
          modalBody.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
            ${modalBody.innerHTML}
          `;
        }
      } else {
        // Browser fallback
        console.error(`❌ ${message}`);
      }
    } catch (error) {
      console.error(`❌ ${message}`);
    }
  }

  
  
  showWarning(message) {
    console.warn('Warning:', message);
    // Try to show in modal first, then fallback to alert
    try {
      const modal = document.getElementById('admin-modal');
      if (modal && !modal.classList.contains('hidden')) {
        // Show warning in current modal
        const modalBody = document.getElementById('modal-body');
        if (modalBody) {
          modalBody.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
            ${modalBody.innerHTML}
          `;
        }
      } else {
        console.warn(`⚠️ ${message}`);
      }
    } catch (error) {
      console.warn(`⚠️ ${message}`);
    }
  }

  updateLastUpdated() {
    const now = new Date();
    this.updateElement('last-updated', now.toLocaleTimeString());
  }

  // Auto-refresh functionality
  startAutoRefresh() {
    // Stop previous timer if it exists
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer);
      this.refreshTimer = null;
    }
    
    // Start only if auto-refresh is enabled
    if (this.autoRefreshEnabled) {
      this.refreshTimer = setInterval(() => {
        this.loadSectionData(this.currentSection);
        this.updateLastUpdated();
      }, this.refreshInterval);
    }
  }

  stopAutoRefresh() {
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer);
      this.refreshTimer = null;
    }
    
    if (this.votingTimer) {
      clearInterval(this.votingTimer);
      this.votingTimer = null;
    }
  }

  // Auto-refresh toggle
  toggleAutoRefresh() {
    this.autoRefreshEnabled = !this.autoRefreshEnabled;
    
    const toggleButton = document.getElementById('auto-refresh-toggle');
    const icon = '🔄';
    
    if (this.autoRefreshEnabled) {
      this.startAutoRefresh();
      toggleButton.className = 'btn btn-secondary enabled';
      toggleButton.title = i18n.t('controls.auto_refresh_enabled');
      toggleButton.innerHTML = icon;
    } else {
      this.stopAutoRefresh();
      toggleButton.className = 'btn btn-secondary disabled';
      toggleButton.title = i18n.t('controls.auto_refresh_disabled');
      toggleButton.innerHTML = icon;
    }
    
    console.log('Auto refresh:', this.autoRefreshEnabled ? 'enabled' : 'disabled');
  }
  
  // Update auto-refresh toggle translations
  updateAutoRefreshToggle() {
    const toggleButton = document.getElementById('auto-refresh-toggle');
    if (toggleButton) {
      const icon = '🔄';
      
      // Update only the title (tooltip), icon remains without text
      if (this.autoRefreshEnabled) {
        toggleButton.title = i18n.t('controls.auto_refresh_enabled');
      } else {
        toggleButton.title = i18n.t('controls.auto_refresh_disabled');
      }
      toggleButton.innerHTML = icon;
    }
  }

  // Action functions
  async supportProject(projectId) {
    try {
      // In real implementation, Web3 wallet integration will be here
      this.showModal(i18n.t('projects.support_project_title'), `
        <div class="alert alert-info">
          <strong>${i18n.t('messages.info')}:</strong> ${i18n.t('projects.web3_required')}
        </div>
        <p>${i18n.t('projects.project_id')}: ${projectId}</p>
        <p>${i18n.t('projects.support_coming_soon')}</p>
      `);
    } catch (error) {
      this.showError(i18n.t('projects.support_error'));
    }
  }

  async viewProject(projectId) {
    try {
      const project = await this.fetchJSON(`/projects/${projectId}`);
      const progress = await this.fetchJSON(`/projects/${projectId}/progress`);
      
      this.showProjectDetailsModal(project, progress);
      
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_to_load_project_details'));
    }
  }

  showProjectDetailsModal(project, progress) {
    const modalTitle = i18n.t('projects.details_title');
    
    // Format dates
    const createdDate = project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Не указано';
    const deadlineText = project.deadline ? 
      new Date(project.deadline).toLocaleDateString() : 
      'Не установлен';
    const etaText = progress?.eta_estimate ? 
      new Date(progress.eta_estimate).toLocaleDateString() : 
      'Не установлен';
    
    // Calculate additional metrics
    const progressToTargetPercent = progress?.progress_to_target_percent || 0;
    const progressToSoftCapPercent = progress?.progress_to_soft_cap_percent || 0;
    
    const modalBody = `
      <div class="project-details-modal">
        <!-- Project Basic Info -->
        <div class="project-section">
          <h5>${this.escapeHtml(project.name)}</h5>
          <div class="project-meta">
            <span class="badge badge-${this.getStatusBadgeClass(project.status)}">${project.status}</span>
            <span class="badge badge-secondary">${this.escapeHtml(project.category)}</span>
          </div>
        </div>
        
        <!-- Description -->
        <div class="project-section">
          <h6>${i18n.t('projects.description')}</h6>
          <p class="project-description">${this.escapeHtml(project.description)}</p>
        </div>
        
        <!-- Funding Information -->
        <div class="project-section">
          <h6>${i18n.t('projects.funding_info')}</h6>
          <div class="funding-grid">
            <div class="funding-item">
              <label>${i18n.t('projects.target_amount')}:</label>
              <span>${this.formatETH(project.target)} ETH</span>
            </div>
            <div class="funding-item">
              <label>${i18n.t('projects.soft_cap')}:</label>
              <span>${this.formatETH(project.soft_cap)} ETH</span>
            </div>
            <div class="funding-item">
              <label>${i18n.t('projects.hard_cap')}:</label>
              <span>${this.formatETH(project.hard_cap || 0)} ETH</span>
            </div>
            <div class="funding-item">
              <label>${i18n.t('projects.total_allocated')}:</label>
              <span>${this.formatETH(progress?.total_allocated || 0)} ETH</span>
            </div>
            <div class="funding-item">
              <label>${i18n.t('projects.total_paid_out')}:</label>
              <span>${this.formatETH(progress?.total_paid_out || 0)} ETH</span>
            </div>
          </div>
        </div>
        
        <!-- Progress Statistics -->
        <div class="project-section">
          <h6>${i18n.t('projects.progress_stats')}</h6>
          <div class="progress-stats">
            <div class="progress-item">
              <label>${i18n.t('projects.progress_to_target')}:</label>
              <div class="progress-bar-container">
                <div class="progress">
                  <div class="progress-bar" style="width: ${Math.min(100, progressToTargetPercent)}%"></div>
                </div>
                <span class="progress-text">${progressToTargetPercent.toFixed(1)}%</span>
              </div>
            </div>
            <div class="progress-item">
              <label>${i18n.t('projects.progress_to_soft_cap')}:</label>
              <div class="progress-bar-container">
                <div class="progress">
                  <div class="progress-bar bg-warning" style="width: ${Math.min(100, progressToSoftCapPercent)}%"></div>
                </div>
                <span class="progress-text">${progressToSoftCapPercent.toFixed(1)}%</span>
              </div>
            </div>
            <div class="funding-item">
              <label>${i18n.t('projects.lacking_to_target')}:</label>
              <span>${this.formatETH(progress?.lacking_to_target || 0)} ETH</span>
            </div>
            <div class="funding-item">
              <label>${i18n.t('projects.lacking_to_soft_cap')}:</label>
              <span>${this.formatETH(progress?.lacking_to_soft_cap || 0)} ETH</span>
            </div>
          </div>
        </div>
        
        <!-- Community Information -->
        <div class="project-section">
          <h6>${i18n.t('projects.community_info')}</h6>
          <div class="community-grid">
            <div class="community-item">
              <label>${i18n.t('projects.unique_donors')}:</label>
              <span>${progress?.unique_donors || 0}</span>
            </div>
            <div class="community-item">
              <label>${i18n.t('projects.allocation_count')}:</label>
              <span>${progress?.allocation_count || 0}</span>
            </div>
            <div class="community-item">
              <label>${i18n.t('projects.payout_count')}:</label>
              <span>${progress?.payout_count || 0}</span>
            </div>
          </div>
        </div>
        
        <!-- Milestones -->
        <div class="project-section">
          <h6>${i18n.t('projects.milestones')}</h6>
          <div class="milestones-grid">
            <div class="milestone-item">
              <label>${i18n.t('projects.target_reached')}:</label>
              <span class="badge ${progress?.is_target_reached ? 'badge-success' : 'badge-secondary'}">
                ${progress?.is_target_reached ? i18n.t('projects.yes') : i18n.t('projects.no')}
              </span>
            </div>
            <div class="milestone-item">
              <label>${i18n.t('projects.soft_cap_reached')}:</label>
              <span class="badge ${progress?.is_soft_cap_reached ? 'badge-success' : 'badge-secondary'}">
                ${progress?.is_soft_cap_reached ? i18n.t('projects.yes') : i18n.t('projects.no')}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Timeline Information -->
        <div class="project-section">
          <h6>${i18n.t('projects.timeline')}</h6>
          <div class="timeline-grid">
            <div class="timeline-item">
              <label>${i18n.t('projects.created_date')}:</label>
              <span>${createdDate}</span>
            </div>
            <div class="timeline-item">
              <label>${i18n.t('projects.deadline')}:</label>
              <span>${deadlineText}</span>
            </div>
            <div class="timeline-item">
              <label>${i18n.t('projects.eta_estimate')}:</label>
              <span>${etaText}</span>
            </div>
          </div>
        </div>
      </div>
      
      <style>
        .project-details-modal {
          max-width: 100%;
        }
        .project-section {
          margin-bottom: 1.5rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid #eee;
        }
        .project-section:last-child {
          border-bottom: none;
          margin-bottom: 0;
        }
        .project-meta {
          margin-top: 0.5rem;
        }
        .project-meta .badge {
          margin-right: 0.5rem;
        }
        .project-description {
          margin: 0.5rem 0;
          line-height: 1.6;
          color: #555;
        }
        .funding-grid, .community-grid, .milestones-grid, .timeline-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 0.75rem;
          margin-top: 0.75rem;
        }
        .funding-item, .community-item, .milestone-item, .timeline-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem;
          background: #f8f9fa;
          border-radius: 4px;
        }
        .funding-item label, .community-item label, .milestone-item label, .timeline-item label {
          font-weight: 500;
          margin: 0;
          color: #666;
        }
        .progress-stats {
          margin-top: 0.75rem;
        }
        .progress-item {
          margin-bottom: 1rem;
        }
        .progress-item label {
          display: block;
          font-weight: 500;
          margin-bottom: 0.5rem;
          color: #666;
        }
        .progress-bar-container {
          display: flex;
          align-items: center;
          gap: 0.75rem;
        }
        .progress-bar-container .progress {
          flex: 1;
          height: 20px;
        }
        .progress-text {
          font-weight: 500;
          min-width: 50px;
          text-align: right;
        }
        @media (max-width: 768px) {
          .funding-grid, .community-grid, .milestones-grid, .timeline-grid {
            grid-template-columns: 1fr;
          }
        }
      </style>
    `;
    
    const modalFooter = `
      <button class="btn btn-primary" onclick="app.supportProject('${project.id}')">${i18n.t('buttons.support_project')}</button>
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.close')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }

  // Voting timer functionality
  startVotingTimer(roundInfo) {
    // Clear existing timer
    if (this.votingTimer) {
      clearInterval(this.votingTimer);
    }

    const updateTimer = () => {
      const now = new Date();
      let targetTime;
      
      if (roundInfo.phase === 'commit') {
        targetTime = new Date(roundInfo.end_commit);
      } else if (roundInfo.phase === 'reveal') {
        targetTime = new Date(roundInfo.end_reveal);
      } else {
        this.updateElement('voting-timer', '00:00:00');
        return;
      }

      const timeDiff = targetTime.getTime() - now.getTime();
      
      if (timeDiff <= 0) {
        this.updateElement('voting-timer', '00:00:00');
        clearInterval(this.votingTimer);
        // Refresh voting section when phase ends
        this.loadVotingSection();
        return;
      }

      const hours = Math.floor(timeDiff / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
      
      const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      this.updateElement('voting-timer', timeString);
    };

    // Update immediately and then every second
    updateTimer();
    this.votingTimer = setInterval(updateTimer, 1000);
  }

  // Generate random salt for commit-reveal voting
  generateRandomSalt() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 32; i++) {
      result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
  }

  // Submit commit vote
  async submitCommitVote(roundId) {
    try {
      // Collect all votes from the form
      const votes = [];
      const saltInput = document.getElementById('vote-salt');
      
      if (!saltInput || !saltInput.value) {
        this.showError('Salt is required for commit voting');
        return;
      }
      
      const salt = saltInput.value;
      const projects = [];
      const choices = [];
      
      // Get current round info to get project list
      const roundInfo = await this.fetchJSON('/votes/current-round');
      
      if (!roundInfo.projects) {
        this.showError('No projects found for voting');
        return;
      }
      
      // Collect votes for each project
      let hasVotes = false;
      roundInfo.projects.forEach(project => {
        const radioInputs = document.querySelectorAll(`input[name="vote-${project.id}"]:checked`);
        if (radioInputs.length > 0) {
          const choice = radioInputs[0].value;
          projects.push(project.id);
          
          // Convert choice to number (0=NotParticipating, 1=Abstain, 2=Against, 3=For)
          const choiceMap = {
            'not_participating': 0,
            'abstain': 1,
            'against': 2,
            'for': 3
          };
          choices.push(choiceMap[choice] || 0);
          
          if (choice !== 'not_participating') {
            hasVotes = true;
          }
        } else {
          // Default to not participating
          projects.push(project.id);
          choices.push(0);
        }
      });
      
      if (!hasVotes) {
        const confirmSubmit = confirm('You have not selected any votes (all projects set to "Not Participating"). Do you want to continue?');
        if (!confirmSubmit) return;
      }
      
      // Check for wallet address
      if (!this.walletAddress) {
        this.showError(i18n.t('admin_modals.messages.wallet_address_required'));
        return;
      }
      
      // Create hash for commit (simplified - in real implementation this would use Web3)
      const voteData = { projects, choices, salt, voter: this.walletAddress };
      const hash = this.simpleHash(JSON.stringify(voteData));
      
      // Submit commit to backend
      const response = await this.fetchJSON(`/votes/${roundId}/commit`, {
        method: 'POST',
        body: JSON.stringify({
          hash: `0x${hash}`,
          projects: projects,
          choices: choices
        })
      });
      
      // Store vote data locally for reveal phase
      localStorage.setItem(`vote-data-${roundId}`, JSON.stringify(voteData));
      
      this.showSuccess(i18n.t('admin_modals.messages.vote_committed_successfully'));
      
      // Refresh voting section
      this.loadVotingSection();
      
    } catch (error) {
      console.error('Failed to submit commit vote:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_submit_commit_vote'));
    }
  }

  // Submit reveal vote
  async submitRevealVote(roundId) {
    try {
      const saltInput = document.getElementById('reveal-salt');
      
      if (!saltInput || !saltInput.value) {
        this.showError(i18n.t('admin_modals.messages.salt_required_for_reveal'));
        return;
      }
      
      const salt = saltInput.value;
      
      // Try to get stored vote data
      const storedVoteData = localStorage.getItem(`vote-data-${roundId}`);
      if (storedVoteData) {
        const voteData = JSON.parse(storedVoteData);
        if (voteData.salt !== salt) {
          this.showError(i18n.t('admin_modals.messages.salt_does_not_match'));
          return;
        }
        
        // Submit reveal with stored data
        const response = await this.fetchJSON(`/votes/${roundId}/reveal`, {
          method: 'POST',
          body: JSON.stringify({
            projects: voteData.projects,
            choices: voteData.choices,
            salt: salt
          })
        });
        
        this.showSuccess(i18n.t('admin_modals.messages.vote_revealed_successfully'));
        
        // Mark that user has revealed votes for this round
        localStorage.setItem(`vote-revealed-${roundId}`, 'true');
        
        // Clean up stored data
        localStorage.removeItem(`vote-data-${roundId}`);
        
      } else {
        this.showError(i18n.t('admin_modals.messages.no_committed_vote_data_found'));
        return;
      }
      
      // Refresh voting section
      this.loadVotingSection();
      
    } catch (error) {
      console.error('Failed to reveal vote:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_reveal_vote'));
    }
  }

  // Check if user has already voted in the current round
  checkUserVotingStatus(roundId) {
    // Check if there's stored vote data for this round (means user has committed vote)
    const storedVoteData = localStorage.getItem(`vote-data-${roundId}`);
    const revealedFlag = localStorage.getItem(`vote-revealed-${roundId}`);
    
    return {
      hasCommitted: storedVoteData !== null,
      hasRevealed: revealedFlag !== null,
      canCommit: storedVoteData === null && revealedFlag === null,
      canReveal: storedVoteData !== null && revealedFlag === null
    };
  }

  // Reset user voting status for a specific round (for admin purposes)
  resetUserVotingStatus(roundId) {
    localStorage.removeItem(`vote-data-${roundId}`);
    localStorage.removeItem(`vote-revealed-${roundId}`);
    console.log(`Voting status reset for round ${roundId}`);
    // Refresh voting section to update UI
    this.loadVotingSection();
  }

  // Generate hashed commit
  generateCommitHash(projects, choices, salt) {
    const hash = this.simpleHash(JSON.stringify({ projects, choices, salt }));
    return hash;
  }

  // Simple hash function for development purposes
  simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash).toString(16);
  }

  async exportTreasuryData() {
    try {
      const response = await fetch(`${this.baseURL}/export/donations?format=csv`);
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'treasury_data.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        this.showSuccess(i18n.t('treasury.export_success'));
      } else {
        throw new Error('Export failed');
      }
    } catch (error) {
      this.showError(i18n.t('treasury.export_treasury_error'));
    }
  }

  async exportPersonalData() {
    if (!this.walletAddress) {
      this.showError(i18n.t('treasury.load_personal_stats_first'));
      return;
    }
    
    try {
      const params = new URLSearchParams();
      params.append('donor_address', this.walletAddress);
      params.append('format', 'csv');
      
      const response = await fetch(`${this.baseURL}/export/donations?${params}`);
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my_contributions.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        this.showSuccess(i18n.t('personal.export_success'));
      } else {
        throw new Error('Export failed');
      }
    } catch (error) {
      this.showError(i18n.t('treasury.export_personal_error'));
    }
  }

  // Enhanced export functionality for admin
  async showExportOptions() {
    const modalTitle = i18n.t('treasury.export_data_title');
    const modalBody = `
      <div class="form-section">
        <h5>${i18n.t('treasury.quick_export')}</h5>
        <div class="action-grid">
          <button class="btn btn-primary" onclick="app.exportAllDonations()">${i18n.t('treasury.export_all_donations')}</button>
          <button class="btn btn-primary" onclick="app.exportAllAllocations()">${i18n.t('treasury.export_all_allocations')}</button>
          <button class="btn btn-primary" onclick="app.exportVotingResults()">${i18n.t('treasury.export_voting_results')}</button>
          <button class="btn btn-primary" onclick="app.exportComprehensiveReport()">${i18n.t('treasury.comprehensive_report')}</button>
        </div>
      </div>
      
      <div class="form-section">
        <h5>${i18n.t('treasury.custom_export')}</h5>
        <form id="custom-export-form">
          <div class="form-row">
            <div class="form-group">
              <label for="export-type">${i18n.t('treasury.data_type')}</label>
              <select class="form-control" id="export-type">
                <option value="donations">${i18n.t('treasury.donations')}</option>
                <option value="allocations">${i18n.t('treasury.allocations')}</option>
                <option value="voting-results">${i18n.t('treasury.voting_results')}</option>
                <option value="comprehensive">${i18n.t('treasury.comprehensive')}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="export-format">${i18n.t('treasury.format')}</label>
              <select class="form-control" id="export-format">
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="export-date-from">${i18n.t('treasury.date_from')}</label>
              <input type="date" class="form-control" id="export-date-from">
            </div>
            <div class="form-group">
              <label for="export-date-to">${i18n.t('treasury.date_to')}</label>
              <input type="date" class="form-control" id="export-date-to">
            </div>
          </div>
          
          <div class="form-group">
            <label for="export-limit">${i18n.t('treasury.record_limit')}</label>
            <input type="number" class="form-control" id="export-limit" value="10000" min="1" max="50000">
            <div class="form-text">${i18n.t('treasury.max_records_export')}</div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="include-personal-data">
            <label for="include-personal-data">${i18n.t('treasury.include_personal_data')}</label>
          </div>
        </form>
      </div>
      
      <div class="form-section">
        <h5>${i18n.t('treasury.analytics_reports')}</h5>
        <div class="action-grid">
          <button class="btn btn-secondary" onclick="app.generateProjectAnalytics()">${i18n.t('treasury.project_analytics')}</button>
          <button class="btn btn-secondary" onclick="app.generateVotingAnalytics()">${i18n.t('treasury.voting_analytics')}</button>
          <button class="btn btn-secondary" onclick="app.generateTreasuryAnalytics()">${i18n.t('treasury.treasury_analytics')}</button>
          <button class="btn btn-secondary" onclick="app.generatePrivacyReport()">${i18n.t('treasury.privacy_report')}</button>
        </div>
      </div>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.close')}</button>
      <button class="btn btn-primary" onclick="app.executeCustomExport()">${i18n.t('treasury.execute_export')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }

  // Quick export functions
  async exportAllDonations() {
    await this.performExport('/export/donations', 'donations');
  }

  async exportAllAllocations() {
    await this.performExport('/export/allocations', 'allocations');
  }

  async exportVotingResults() {
    await this.performExport('/export/voting-results', 'voting_results');
  }

  async exportComprehensiveReport() {
    await this.performExport('/export/comprehensive-report', 'comprehensive_report', 'json');
  }

  // Generic export performer
  async performExport(endpoint, filename, format = 'csv') {
    try {
      const params = new URLSearchParams();
      params.append('format', format);
      
      const response = await fetch(`${this.baseURL}${endpoint}?${params}`);
      
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        this.showSuccess(`${filename} ${i18n.t('admin_modals.messages.exported_successfully')}`);
      } else {
        throw new Error(`${i18n.t('admin_modals.messages.export_failed')}: ${response.statusText}`);
      }
    } catch (error) {
      console.error('Export failed:', error);
      this.showError(`${i18n.t('admin_modals.messages.failed_to_export')} ${filename}`);
    }
  }

  // Custom export execution
  async executeCustomExport() {
    const exportType = document.getElementById('export-type').value;
    const format = document.getElementById('export-format').value;
    const dateFrom = document.getElementById('export-date-from').value;
    const dateTo = document.getElementById('export-date-to').value;
    const limit = document.getElementById('export-limit').value;
    const includePersonal = document.getElementById('include-personal-data').checked;
    
    try {
      const params = new URLSearchParams();
      params.append('format', format);
      
      if (dateFrom) params.append('date_from', dateFrom);
      if (dateTo) params.append('date_to', dateTo);
      if (limit) params.append('limit', limit);
      if (includePersonal) params.append('include_personal_data', 'true');
      
      let endpoint;
      switch (exportType) {
        case 'donations':
          endpoint = '/export/donations';
          break;
        case 'allocations':
          endpoint = '/export/allocations';
          break;
        case 'voting-results':
          endpoint = '/export/voting-results';
          break;
        case 'comprehensive':
          endpoint = '/export/comprehensive-report';
          break;
        default:
          throw new Error(i18n.t('admin_modals.messages.invalid_export_type'));
      }
      
      await this.performExport(endpoint, exportType, format);
      this.closeModal();
      
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_execute_export'));
    }
  }

  // Analytics report generation
  async generateProjectAnalytics() {
    try {
      const analytics = await this.fetchJSON('/reports/project-analytics');
      this.displayAnalyticsReport(i18n.t('analytics.project_report.title'), this.renderProjectAnalytics(analytics));
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_to_generate_project_analytics'));
    }
  }

  async generateVotingAnalytics() {
    try {
      const analytics = await this.fetchJSON('/reports/voting-analytics');
      this.displayAnalyticsReport(i18n.t('analytics.voting_report.title'), this.renderVotingAnalytics(analytics));
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_to_generate_voting_analytics'));
    }
  }

  async generateTreasuryAnalytics() {
    try {
      const analytics = await this.fetchJSON('/reports/treasury-analytics');
      this.displayAnalyticsReport(i18n.t('analytics.treasury_report.title'), this.renderTreasuryAnalytics(analytics));
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_to_generate_treasury_analytics'));
    }
  }

  async generatePrivacyReport() {
    try {
      const report = await this.fetchJSON('/privacy/report?data_type=donations');
      this.displayAnalyticsReport(i18n.t('analytics.privacy_report.title'), this.renderPrivacyReport(report));
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_to_generate_privacy_report'));
    }
  }


  // Analytics report renderers
  renderProjectAnalytics(analytics) {
    return `
      <div class="analytics-report">
        <div class="report-header">
          <h4>${i18n.t('analytics.project_report.title')}</h4>
          <p>${i18n.t('analytics.project_report.generated')}: ${analytics.generated_at || new Date().toLocaleString()}</p>
          <p>${i18n.t('analytics.project_report.period')}: ${analytics.period_days || 30} ${i18n.t('analytics.project_report.days')} | ${i18n.t('analytics.project_report.category')}: ${analytics.category || i18n.t('analytics.privacy_report.all')}</p>
        </div>

        <div class="section">
          <div>${i18n.t('analytics.project_report.total_projects')}: <strong>${analytics.summary?.total_projects || 0}</strong></div>
          <div>${i18n.t('analytics.project_report.total_target')}: <strong>${this.formatETH(analytics.summary?.total_target || 0)} ETH</strong></div>
          <div>${i18n.t('analytics.project_report.total_allocated')}: <strong>${this.formatETH(analytics.summary?.total_allocated || 0)} ETH</strong></div>
          <div>${i18n.t('analytics.project_report.funding_progress')}: <strong>${analytics.summary?.total_target && analytics.summary?.total_allocated ? (analytics.summary.total_allocated / analytics.summary.total_target * 100).toFixed(1) : 0}%</strong></div>
        </div>
        
        <div class="section">
          <h5>${i18n.t('analytics.project_report.by_status')}</h5>
          <table class="data-table">
            <thead><tr><th>${i18n.t('analytics.project_report.status_header')}</th><th>${i18n.t('analytics.project_report.count_header')}</th><th>${i18n.t('analytics.project_report.target_header')}</th><th>${i18n.t('analytics.project_report.allocated_header')}</th></tr></thead>
            <tbody>
              ${analytics.by_status ? Object.entries(analytics.by_status).map(([status, data]) => `
                <tr>
                  <td><span class="badge badge-info">${status}</span></td>
                  <td>${data.count || 0}</td>
                  <td>${this.formatETH(data.total_target || 0)} ETH</td>
                  <td>${this.formatETH(data.total_allocated || 0)} ETH</td>
                </tr>
              `).join('') : '<tr><td colspan="4" class="text-center text-muted">' + i18n.t('messages.no_data') + '</td></tr>'}
            </tbody>
          </table>
        </div>
        
        <div class="section">
          <h5>${i18n.t('analytics.project_report.funding_progress_distribution')}</h5>
          <div class="progress-stats">
            <div>${i18n.t('analytics.project_report.fully_funded')}: ${analytics.funding_progress?.fully_funded || 0}</div>
            <div>${i18n.t('analytics.project_report.over_50_percent')}: ${analytics.funding_progress?.over_50_percent || 0}</div>
            <div>${i18n.t('analytics.project_report.under_50_percent')}: ${analytics.funding_progress?.under_50_percent || 0}</div>
            <div>${i18n.t('analytics.project_report.no_funding')}: ${analytics.funding_progress?.no_funding || 0}</div>
          </div>
        </div>
      </div>
    `;
  }

  renderVotingAnalytics(analytics) {
    return `
      <div class="analytics-report">
        <div class="report-header">
          <h4>${i18n.t('analytics.voting_report.title')}</h4>
          <p>${i18n.t('analytics.voting_report.generated')}: ${analytics.generated_at || new Date().toLocaleString()}</p>
          <p>${i18n.t('analytics.voting_report.round')}: ${analytics.round_id || 'Не указан'}</p>
        </div>

        <div class="section">
          <div>${i18n.t('analytics.voting_report.projects_voted_on')}: <strong>${analytics.participation_metrics?.total_projects_voted || 0}</strong></div>
          <div>${i18n.t('analytics.voting_report.total_for_votes')}: <strong>${analytics.participation_metrics?.total_for_votes || 0}</strong></div>
          <div>${i18n.t('analytics.voting_report.total_against_votes')}: <strong>${analytics.participation_metrics?.total_against_votes || 0}</strong></div>
          <div>${i18n.t('analytics.voting_report.average_turnout')}: <strong>${analytics.participation_metrics?.average_turnout ? analytics.participation_metrics.average_turnout.toFixed(1) : 0}%</strong></div>
        </div>
        
        ${analytics.project_analysis ? `
          <div class="section">
            <h5>${i18n.t('analytics.voting_report.project_analysis')}</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>${i18n.t('analytics.voting_report.project_header')}</th>
                  <th>${i18n.t('analytics.voting_report.turnout_header')}</th>
                  <th>${i18n.t('analytics.voting_report.support_ratio_header')}</th>
                  <th>${i18n.t('analytics.voting_report.engagement_header')}</th>
                  <th>${i18n.t('analytics.voting_report.consensus_header')}</th>
                </tr>
              </thead>
              <tbody>
                ${analytics.project_analysis.map(p => `
                  <tr>
                    <td>${p.project_id ? p.project_id.substring(0, 8) + '...' : 'Неизвестно'}</td>
                    <td>${p.participation_rate ? p.participation_rate.toFixed(1) : 0}%</td>
                    <td>${p.support_ratio ? p.support_ratio.toFixed(1) : 0}%</td>
                    <td>${p.engagement_score ? p.engagement_score.toFixed(1) : 0}%</td>
                    <td><span class="badge badge-${p.consensus_level === 'high' ? 'success' : 'warning'}">${p.consensus_level || 'Неизвестно'}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      </div>
    `;
  }

  renderTreasuryAnalytics(analytics) {
    return `
      <div class="analytics-report">
        <div class="report-header">
          <h4>${i18n.t('analytics.treasury_report.title')}</h4>
          <p>${i18n.t('analytics.treasury_report.generated')}: ${analytics.generated_at || new Date().toLocaleString()}</p>
        </div>

        <div class="section">
          <div>${i18n.t('analytics.treasury_report.total_earnings')}: <strong>${this.formatETH(analytics.summary?.total_earnings || 0)} ETH</strong></div>
          <div>${i18n.t('analytics.treasury_report.total_fees')}: <strong>${this.formatETH(analytics.summary?.total_fees || 0)} ETH</strong></div>
          <div>${i18n.t('analytics.treasury_report.total_withdrawals')}: <strong>${this.formatETH(analytics.summary?.total_withdrawals || 0)} ETH</strong></div>
          <div>${i18n.t('analytics.treasury_report.net_earnings')}: <strong>${this.formatETH(analytics.summary?.total_earnings && analytics.summary?.total_fees ? (analytics.summary.total_earnings - analytics.summary.total_fees) : 0)} ETH</strong></div>
        </div>

        <div class="section">
          <h5>${i18n.t('analytics.treasury_report.by_source')}</h5>
          <table class="data-table">
            <thead>
              <tr>
                <th>${i18n.t('analytics.treasury_report.source_header')}</th>
                <th>${i18n.t('analytics.treasury_report.amount_header')}</th>
                <th>${i18n.t('analytics.treasury_report.fee_header')}</th>
              </tr>
            </thead>
            <tbody>
              ${analytics.by_source ? Object.entries(analytics.by_source).map(([source, data]) => `
                <tr>
                  <td>${source}</td>
                  <td>${this.formatETH(data.total_earnings || 0)} ETH</td>
                  <td>${this.formatETH(data.total_fees || 0)} ETH</td>
                </tr>
              `).join('') : '<tr><td colspan="3" class="text-center text-muted">' + i18n.t('messages.no_data') + '</td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  renderPrivacyReport(report) {
    return `
      <div class="analytics-report">
        <div class="report-header">
          <h4>${i18n.t('analytics.privacy_report.title')}</h4>
          <p>${i18n.t('analytics.privacy_report.generated')}: ${report.generated_at || new Date().toLocaleString()}</p>
          <p>${i18n.t('analytics.privacy_report.data_type')}: ${report.data_type || i18n.t('analytics.privacy_report.all')}</p>
        </div>
        
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value">${report.k_anonymity?.threshold || 0}</div>
            <div class="metric-label">${i18n.t('analytics.privacy_report.k_anonymity_threshold')}</div>
          </div>
        </div>
        
        <div class="section">
          <h5>${i18n.t('analytics.privacy_report.privacy_metrics')}</h5>
          <div class="privacy-stats">
            <div class="stat-item">
              <div class="stat-label">${i18n.t('analytics.privacy_report.total_records')}</div>
              <div class="stat-value">${report.privacy_metrics?.total_records || 0}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">${i18n.t('analytics.privacy_report.anonymized_records')}</div>
              <div class="stat-value">${report.privacy_metrics?.anonymized_records || 0}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">${i18n.t('analytics.privacy_report.privacy_compliant')}</div>
              <div class="stat-value">
                <span class="badge badge-${report.privacy_metrics?.is_compliant ? 'success' : 'danger'}">
                  ${report.privacy_metrics?.is_compliant ? i18n.t('analytics.privacy_report.yes') : i18n.t('analytics.privacy_report.no')}
                </span>
              </div>
            </div>
          </div>
        </div>
        
        ${report.k_anonymity?.groups ? `
          <div class="section">
            <h5>K-Anonymity Groups</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Group Size</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(report.k_anonymity.groups).map(([size, count]) => `
                  <tr>
                    <td>${size}</td>
                    <td>${count}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      </div>
    `;
  }

  renderPrivacyReport(report) {
    return `
      <div class="analytics-report">
        <div class="report-header">
          <h4>${i18n.t('modal.privacy_report.title')}</h4>
          <p>${i18n.t('modal.privacy_report.k_anonymity_threshold')}: ${report.k_threshold || 5}</p>
        </div>
        
        <div class="alert alert-info">
          <strong>${i18n.t('modal.privacy_report.privacy_protection_status')}:</strong> ${i18n.t('modal.privacy_report.privacy_system_implements')}
        </div>
        
        <div class="section">
          <h5>${i18n.t('modal.privacy_report.data_protection_summary')}</h5>
          <p>${i18n.t('modal.privacy_report.public_exports_filtered')}</p>
          <p>${i18n.t('modal.privacy_report.personal_data_export_requires')}</p>
          <p>${i18n.t('modal.privacy_report.admin_exports_include')}</p>
        </div>
      </div>
    `;
  }

  displayAnalyticsReport(title, content) {
    this.displayAdminContent(title, content);
    this.closeModal();
  }

  // Admin functions
  async showProjectForm() {
    const modalTitle = i18n.t('modal.create_new_project');
    const modalBody = `
      <form id="create-project-form">
        <div class="form-row">
          <div class="form-group">
            <label for="project-name">${i18n.t('modal.project_name')} *</label>
            <input type="text" class="form-control" id="project-name" required maxlength="200">
          </div>
          <div class="form-group">
            <label for="project-category">${i18n.t('modal.category')} *</label>
            <select class="form-control" id="project-category" required>
              <option value="">${i18n.t('modal.select_category')}</option>
              <option value="infrastructure">${i18n.t('modal.infrastructure')}</option>
              <option value="healthcare">${i18n.t('modal.healthcare')}</option>
              <option value="education">${i18n.t('modal.education')}</option>
              <option value="aid">${i18n.t('modal.emergency_aid')}</option>
              <option value="environment">${i18n.t('modal.environment')}</option>
              <option value="technology">${i18n.t('modal.technology')}</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="project-description">${i18n.t('modal.description')} *</label>
          <textarea class="form-control textarea" id="project-description" required maxlength="2000" 
                    placeholder="${i18n.t('modal.description_placeholder')}"></textarea>
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('modal.funding_configuration')}</h5>
          <div class="form-row">
            <div class="form-group">
              <label for="project-target">${i18n.t('modal.target_amount_eth')} *</label>
              <input type="number" class="form-control" id="project-target" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
              <label for="project-soft-cap">${i18n.t('modal.soft_cap_eth')} *</label>
              <input type="number" class="form-control" id="project-soft-cap" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
              <label for="project-hard-cap">${i18n.t('modal.hard_cap_eth')}</label>
              <input type="number" class="form-control" id="project-hard-cap" step="0.01" min="0.01">
            </div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="soft-cap-enabled" checked>
            <label for="soft-cap-enabled">${i18n.t('modal.enable_soft_cap')}</label>
          </div>
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('modal.timeline')}</h5>
          <div class="form-group">
            <label for="project-deadline">${i18n.t('modal.deadline_optional')}</label>
            <input type="datetime-local" class="form-control" id="project-deadline">
            <div class="form-text">${i18n.t('modal.deadline_help_text')}</div>
          </div>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.submitCreateProject()">${i18n.t('modal.create_project')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }

  async submitCreateProject() {
    const projectData = {
      name: document.getElementById('project-name').value,
      description: document.getElementById('project-description').value,
      category: document.getElementById('project-category').value,
      target: parseFloat(document.getElementById('project-target').value),
      soft_cap: parseFloat(document.getElementById('project-soft-cap').value),
      hard_cap: document.getElementById('project-hard-cap').value ? parseFloat(document.getElementById('project-hard-cap').value) : null,
      deadline: document.getElementById('project-deadline').value || null,
      soft_cap_enabled: document.getElementById('soft-cap-enabled').checked
    };
    
    // Validation
    if (!projectData.name || !projectData.description || !projectData.category) {
      this.showError(i18n.t('modal.validation.fill_required_fields'));
      return;
    }
    
    if (projectData.soft_cap > projectData.target) {
      this.showError(i18n.t('modal.validation.soft_cap_greater_than_target'));
      return;
    }
    
    if (projectData.hard_cap && projectData.hard_cap < projectData.target) {
      this.showError(i18n.t('modal.validation.hard_cap_less_than_target'));
      return;
    }
    
    try {
      const response = await this.fetchJSON('/admin/projects', {
        method: 'POST',
        body: JSON.stringify(projectData)
      });
      
      this.showSuccess(i18n.t('projects.creation_success'));
      this.closeModal();
      
      // Refresh projects list if on projects admin page
      if (this.currentSection === 'admin') {
        this.showProjectsAdmin();
      }
      
    } catch (error) {
      console.error('Failed to create project:', error);
      this.showError(i18n.t('modal.validation.failed_to_create_project'));
    }
  }

  async manageCategories() {
    const modalTitle = i18n.t('admin_modals.manage_categories.title');
    
    // Fetch categories from the backend
    let categoriesData = [];
    try {
      const response = await this.fetchJSON('/stats/categories');
      categoriesData = response.data || [];
    } catch (error) {
      console.error('Failed to fetch categories:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_categories'));
      return;
    }
    
    // Generate the categories table body
    let categoriesTableBody = '';
    if (categoriesData.length > 0) {
      categoriesTableBody = categoriesData.map(cat => `
        <tr>
          <td>${cat.category}</td>
          <td>${cat.active_projects || 0}</td>
          <td>${cat.max_limit || 10}</td>
          <td class="action-buttons">
            <button class="btn btn-xs btn-secondary" onclick="window.app.editCategory('${cat.category}')">${i18n.t('admin_modals.manage_categories.edit')}</button>
            <button class="btn btn-xs btn-danger" onclick="window.app.deleteCategory('${cat.category}')" style="margin-left: 5px;">${i18n.t('admin_modals.manage_categories.delete')}</button>
          </td>
        </tr>
      `).join('');
    } else {
      categoriesTableBody = `
        <tr>
          <td colspan="4" class="text-center">${i18n.t('admin_modals.manage_categories.no_categories')}</td>
        </tr>
      `;
    }
    
    const modalBody = `
      <div class="form-section">
        <h5>${i18n.t('admin_modals.manage_categories.title')}</h5>
        <div class="form-row">
          <div class="form-group">
            <label for="new-category-name">${i18n.t('admin_modals.manage_categories.category_name')}</label>
            <input type="text" class="form-control" id="new-category-name" placeholder="${i18n.t('admin_modals.manage_categories.category_name_placeholder')}">
          </div>
          <div class="form-group">
            <label for="new-category-limit">${i18n.t('admin_modals.manage_categories.max_active_projects')}</label>
            <input type="number" class="form-control" id="new-category-limit" value="10" min="1">
          </div>
          <div class="form-group">
            <button class="btn btn-primary" onclick="app.addCategory()">${i18n.t('admin_modals.manage_categories.add_category')}</button>
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <h5>${i18n.t('admin_modals.manage_categories.existing_categories')}</h5>
        <table class="data-table">
          <thead>
            <tr>
              <th>${i18n.t('admin_modals.manage_categories.category')}</th>
              <th>${i18n.t('admin_modals.manage_categories.active_projects')}</th>
              <th>${i18n.t('admin_modals.manage_categories.max_limit')}</th>
              <th>${i18n.t('admin_modals.manage_categories.actions')}</th>
            </tr>
          </thead>
          <tbody id="categories-table-body">
            ${categoriesTableBody}
          </tbody>
        </table>
      </div>
    `;
    
    this.showModal(modalTitle, modalBody);
  }

  async showMintSBTForm() {
    const modalTitle = i18n.t('modal.mint_sbt.title');
    const modalBody = `
      <form id="mint-sbt-form">
        <div class="alert alert-info">
          <strong>${i18n.t('modal.mint_sbt.note')}:</strong> ${i18n.t('modal.mint_sbt.sbt_description')}
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="sbt-recipient">${i18n.t('modal.mint_sbt.recipient_address')}</label>
            <input type="text" class="form-control" id="sbt-recipient" 
                   placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$" required>
          </div>
          <div class="form-group">
            <label for="sbt-donation-amount">${i18n.t('modal.mint_sbt.donation_amount_eth')}</label>
            <input type="number" class="form-control" id="sbt-donation-amount" 
                   step="0.01" min="0.01" required>
            <div class="form-text">${i18n.t('modal.mint_sbt.donation_amount_help')}</div>
          </div>
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('modal.mint_sbt.weight_configuration')}</h5>
          <div class="form-row">
            <div class="form-group">
              <label for="weight-mode">${i18n.t('modal.mint_sbt.weight_calculation_mode')}</label>
              <select class="form-control" id="weight-mode">
                <option value="linear">${i18n.t('modal.mint_sbt.linear_ratio')}</option>
                <option value="quadratic">${i18n.t('modal.mint_sbt.quadratic_diminishing')}</option>
                <option value="logarithmic">${i18n.t('modal.mint_sbt.logarithmic_heavy')}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="calculated-weight">${i18n.t('modal.mint_sbt.calculated_weight')}</label>
              <input type="text" class="form-control" id="calculated-weight" readonly>
            </div>
          </div>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.submitMintSBT()">${i18n.t('modal.mint_sbt.title')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
    
    // Add event listeners for weight calculation
    document.getElementById('sbt-donation-amount').addEventListener('input', this.calculateSBTWeight.bind(this));
    document.getElementById('weight-mode').addEventListener('change', this.calculateSBTWeight.bind(this));
    this.calculateSBTWeight();
  }

  calculateSBTWeight() {
    const donationAmount = parseFloat(document.getElementById('sbt-donation-amount').value) || 0;
    const weightMode = document.getElementById('weight-mode').value;
    
    let weight = 0;
    
    switch (weightMode) {
      case 'linear':
        weight = donationAmount;
        break;
      case 'quadratic':
        weight = Math.sqrt(donationAmount);
        break;
      case 'logarithmic':
        weight = donationAmount > 0 ? Math.log(donationAmount + 1) : 0;
        break;
    }
    
    document.getElementById('calculated-weight').value = weight.toFixed(3);
  }

  async showStartVotingForm() {
    const modalTitle = i18n.t('modal.start_voting.title');
    const modalBody = `
      <form id="start-voting-form">
        <div class="alert alert-warning">
          <strong>${i18n.t('modal.start_voting.warning')}</strong> ${i18n.t('modal.start_voting.override_warning')}
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('modal.start_voting.timing_configuration')}</h5>
          <div class="form-row">
            <div class="form-group">
              <label for="commit-duration">${i18n.t('modal.start_voting.commit_phase_duration')}</label>
              <input type="number" class="form-control" id="commit-duration" value="168" min="1">
              <div class="form-text">${i18n.t('modal.start_voting.commit_default')}</div>
            </div>
            <div class="form-group">
              <label for="reveal-duration">${i18n.t('modal.start_voting.reveal_phase_duration')}</label>
              <input type="number" class="form-control" id="reveal-duration" value="72" min="1">
              <div class="form-text">${i18n.t('modal.start_voting.reveal_default')}</div>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('modal.start_voting.voting_configuration')}</h5>
          <div class="form-row">
            <div class="form-group">
              <label for="counting-method">${i18n.t('modal.start_voting.counting_method')}</label>
              <select class="form-control" id="counting-method">
                <option value="weighted">${i18n.t('modal.start_voting.weighted_voting')}</option>
                <option value="borda">${i18n.t('modal.start_voting.borda_count')}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="cancellation-threshold">${i18n.t('modal.start_voting.auto_cancellation_threshold')}</label>
              <input type="number" class="form-control" id="cancellation-threshold" value="66" min="1" max="100">
              <div class="form-text">${i18n.t('modal.start_voting.minimum_turnout')}</div>
            </div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="enable-auto-cancellation" checked>
            <label for="enable-auto-cancellation">${i18n.t('modal.start_voting.enable_auto_cancellation')}</label>
          </div>
        </div>
        
        <div class="form-section" id="project-selection">
          <h5>${i18n.t('modal.start_voting.select_projects_voting')}</h5>
          <div class="text-muted mb-2">${i18n.t('modal.start_voting.loading_projects')}</div>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.submitStartVoting()">${i18n.t('modal.start_voting.start_voting_round')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
    
    // Load available projects
    this.loadProjectsForVoting();
  }

  async loadProjectsForVoting() {
    try {
      const projects = await this.fetchJSON('/projects?status=active&limit=100');
      const container = document.getElementById('project-selection');
      
      if (!projects || projects.length === 0) {
        container.innerHTML = `
          <h5>${i18n.t('modal.start_voting.select_projects_voting')}</h5>
          <div class="alert alert-warning">${i18n.t('modal.start_voting.no_active_projects')}</div>
        `;
        return;
      }
      
      let html = `<h5>${i18n.t('modal.start_voting.select_projects_voting')}</h5>`;
      projects.forEach(project => {
        html += `
          <div class="checkbox-group">
            <input type="checkbox" id="project-${project.id}" value="${project.id}" class="voting-project">
            <label for="project-${project.id}">
              <strong>${this.escapeHtml(project.name)}</strong> 
              (${this.escapeHtml(project.category)}) - ${this.formatETH(project.target)} ETH
            </label>
          </div>
        `;
      });
      
      container.innerHTML = html;
    } catch (error) {
      console.error('Failed to load projects for voting:', error);
      const container = document.getElementById('project-selection');
      if (container) {
        container.innerHTML = `
          <h5>${i18n.t('modal.start_voting.select_projects_voting')}</h5>
          <div class="alert alert-danger">${i18n.t('messages.connection_error')}</div>
        `;
      }
    }
  }

  async reindexBlockchain() {
    try {
      await this.fetchJSON('/admin/indexer/reindex', { method: 'POST' });
      this.showSuccess(i18n.t('admin_modals.messages.blockchain_reindexing_initiated'));
      // Refresh indexer status
      this.loadAdminSection();
    } catch (error) {
      this.showError(i18n.t('admin_modals.messages.failed_to_start_reindexing'));
    }
  }

  // Modal system
  showModal(title, body, footer = '') {
    const modal = document.getElementById('admin-modal');
    if (modal) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = body;
      document.getElementById('modal-footer').innerHTML = footer || `
        <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('admin_modals.messages.close')}</button>
      `;
      modal.classList.remove('hidden');
    } else {
      console.error('Admin modal not found');
    }
  }

  closeModal() {
    const modal = document.getElementById('admin-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  // Show success message
  showSuccess(message) {
    console.log('Success:', message);
    // Try to show in modal first, then fallback to alert
    try {
      const modal = document.getElementById('admin-modal');
      if (modal && !modal.classList.contains('hidden')) {
        // Show success in current modal
        const modalBody = document.getElementById('modal-body');
        if (modalBody) {
          modalBody.innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> ${message}
            </div>
            ${modalBody.innerHTML}
          `;
        }
      } else {
        console.log(`✅ ${message}`);
      }
    } catch (error) {
      console.log(`✅ ${message}`);
    }
  }

  // Additional admin functions
  async showProjectsAdmin() {
    try {
      const projects = await this.fetchJSON('/projects?limit=100');
      this.displayAdminContent(i18n.t('admin.project_management'), this.renderProjectsAdminTable(projects));
    } catch (error) {
      console.error('Failed to load projects from API:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_projects'));
    }
  }
  async showCategoriesAdmin() {
    try {
      const categories = await this.fetchJSON('/categories');
      this.displayAdminContent(i18n.t('admin.manage_categories'), this.renderCategoriesAdminTable(categories));
    } catch (error) {
      console.error('Failed to fetch categories:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_categories'));
    }
  }
  
  renderCategoriesAdminTable(categories) {
    let html = `
      <div class="mb-3">
        <button class="btn btn-primary" onclick="app.manageCategories()">' + i18n.t('admin.manage_categories') + '</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('admin_modals.manage_categories.category')}</th>
            <th>${i18n.t('admin_modals.manage_categories.active_projects')}</th>
            <th>${i18n.t('admin_modals.manage_categories.max_limit')}</th>
            <th>${i18n.t('admin_modals.manage_categories.actions')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    if (categories && categories.length > 0) {
      categories.forEach(cat => {
        html += `
          <tr>
            <td><strong>${this.escapeHtml(cat.category || cat.name)}</strong></td>
            <td>${cat.active_projects || 0}</td>
            <td>${cat.max_limit || 10}</td>
            <td class="action-buttons">
              <button class="btn btn-xs btn-secondary" onclick="app.editCategory('${cat.category || cat.name}')">${i18n.t('admin_modals.manage_categories.edit')}</button>
              <button class="btn btn-xs btn-danger" onclick="app.deleteCategory('${cat.category || cat.name}')">${i18n.t('admin_modals.manage_categories.delete')}</button>
            </td>
          </tr>
        `;
      });
    } else {
      html += '<tr><td colspan="4" class="text-center text-muted">' + i18n.t('admin_modals.manage_categories.no_categories_found') + '</td></tr>';
    }
    
    html += '</tbody></table>';
    return html;
  }

  renderProjectsAdminTable(projects) {
    let html = `
      <div class="mb-3">
        <button class="btn btn-primary" onclick="window.app.showProjectForm()">${i18n.t('admin_modals.project_management.add_new_project')}</button>
        <div class="mt-2 text-muted">
          <small>
            <strong>${i18n.t('admin_modals.project_management.instruction')}</strong><br>
            • <strong>${i18n.t('admin_modals.project_management.cancel_button')}</strong> - ${i18n.t('admin_modals.project_management.cancel_instruction')}<br>
            • <strong>🗑️ ${i18n.t('admin_modals.project_management.delete_button')}</strong> - ${i18n.t('admin_modals.project_management.delete_instruction')}
          </small>
        </div>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('admin_modals.project_management.name')}</th>
            <th>${i18n.t('modal.category')}</th>
            <th>${i18n.t('admin_modals.member_management.status')}</th>
            <th>${i18n.t('admin_modals.project_management.target')}</th>
            <th>${i18n.t('admin_modals.project_management.allocated')}</th>
            <th>${i18n.t('admin_modals.project_management.progress')}</th>
            <th>${i18n.t('admin_modals.member_management.actions')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    if (projects && projects.length > 0) {
      projects.forEach(project => {
        const progress = (project.total_allocated / project.target * 100).toFixed(1);
        html += `
          <tr>
            <td><strong>${this.escapeHtml(project.name)}</strong></td>
            <td><span class="badge badge-info">${this.escapeHtml(project.category)}</span></td>
            <td><span class="badge badge-${this.getStatusBadgeClass(project.status)}">${project.status}</span></td>
            <td>${this.formatETH(project.target)} ETH</td>
            <td>${this.formatETH(project.total_allocated)} ETH</td>
            <td>${progress}%</td>
            <td class="action-buttons">
              <button class="btn btn-xs btn-secondary" onclick="window.app.editProject('${project.id}')" title="${i18n.t('admin_modals.project_management.edit_project')}">${i18n.t('buttons.edit')}</button>
              <button class="btn btn-xs btn-warning" onclick="window.app.pauseProject('${project.id}')" title="${i18n.t('admin_modals.project_management.pause_project')}">${i18n.t('admin_modals.project_management.pause')}</button>
              <br style="margin: 2px 0;">
              <button class="btn btn-xs btn-danger" onclick="window.app.cancelProject('${project.id}')" title="${i18n.t('admin_modals.project_management.cancel_project')}">${i18n.t('admin_modals.project_management.cancel_button')}</button>
              <button class="btn btn-xs btn-danger" onclick="window.app.deleteProject('${project.id}')" title="${i18n.t('admin_modals.project_management.delete_instruction')}" style="margin-left: 5px; background-color: #8b0000; border-color: #8b0000;">🗑️ ${i18n.t('buttons.delete')}</button>
            </td>
          </tr>
        `;
      });
    } else {
      html += '<tr><td colspan="7" class="text-center text-muted">' + i18n.t('admin_modals.project_management.no_projects_found') + '</td></tr>';
    }
    
    html += '</tbody></table>';
    return html;
  }

  async showMembersAdmin() {
    try {
      const members = await this.fetchJSON('/members?limit=100');
      this.displayAdminContent(i18n.t('admin_modals.member_management.title'), this.renderMembersAdminTable(members));
    } catch (error) {
      console.error('Failed to load members:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_members'));
    }
  }

  renderMembersAdminTable(members) {
    let html = `
      <div class="mb-2">
        <button class="btn btn-primary" onclick="app.showMintSBTForm()">${i18n.t('admin_modals.member_management.mint_new_sbt')}</button>
        <button class="btn btn-secondary ml-2" onclick="app.bulkUpdateWeights()">${i18n.t('admin_modals.member_management.bulk_update_weights')}</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('admin_modals.member_management.address')}</th>
            <th>${i18n.t('admin_modals.member_management.sbt_weight')}</th>
            <th>${i18n.t('admin_modals.member_management.total_donated')}</th>
            <th>${i18n.t('admin_modals.member_management.voting_power')}</th>
            <th>${i18n.t('admin_modals.member_management.status')}</th>
            <th>${i18n.t('admin_modals.member_management.actions')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    if (members && members.length > 0) {
      members.forEach(member => {
        const statusClass = member.status === 'active' ? 'success' : 'secondary';
        const statusText = member.status === 'active' ? i18n.t('admin_modals.member_management.active') : i18n.t('admin_modals.member_management.inactive');
        html += `
          <tr>
            <td><code>${member.address}</code></td>
            <td>${(member.sbt_weight || 0).toFixed(3)}</td>
            <td>${this.formatETH(member.total_donated || 0)} ETH</td>
            <td>${(member.voting_power || 0).toFixed(3)}</td>
            <td><span class="badge badge-${statusClass}">${statusText}</span></td>
            <td class="action-buttons">
              <button class="btn btn-xs btn-secondary" onclick="app.updateMemberWeight('${member.address}')">${i18n.t('admin_modals.member_management.update_weight')}</button>
              <button class="btn btn-xs btn-warning" onclick="app.toggleMemberStatus('${member.address}')">${i18n.t('admin_modals.member_management.toggle_status')}</button>
            </td>
          </tr>
        `;
      });
    } else {
      html += '<tr><td colspan="6" class="text-center text-muted">' + i18n.t('admin_modals.member_management.no_members_found') + '</td></tr>';
    }
    
    html += '</tbody></table>';
    return html;
  }

  async showVotingHistory() {
    try {
      const rounds = await this.fetchJSON('/votes/rounds?limit=10');
      this.displayAdminContent(i18n.t('admin_modals.voting_history.title'), this.renderVotingHistoryTable(rounds));
    } catch (error) {
      console.error('Failed to load voting rounds:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_voting_history'));
    }
  }

  renderVotingHistoryTable(rounds) {
    let html = `
      <div class="mb-2">
        <button class="btn btn-primary" onclick="app.showStartVotingForm()">${i18n.t('admin_modals.voting_history.start_new_round')}</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('admin_modals.voting_history.round_id')}</th>
            <th>${i18n.t('admin_modals.voting_history.start_date')}</th>
            <th>${i18n.t('admin_modals.voting_history.end_date')}</th>
            <th>${i18n.t('admin_modals.member_management.status')}</th>
            <th>${i18n.t('admin_modals.voting_history.participants')}</th>
            <th>${i18n.t('admin_modals.voting_history.turnout')}</th>
            <th>${i18n.t('admin_modals.member_management.actions')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    if (rounds && rounds.length > 0) {
      rounds.forEach(round => {
        const statusClass = round.status === 'completed' ? 'success' : 'warning';
        const statusText = round.status === 'completed' ? i18n.t('admin_modals.voting_history.completed') : round.status;
        html += `
          <tr>
            <td><strong>#${round.round_id}</strong></td>
            <td>${round.start_date || 'Не указано'}</td>
            <td>${round.end_date || 'Не указано'}</td>
            <td><span class="badge badge-${statusClass}">${statusText}</span></td>
            <td>${round.participants || 0}</td>
            <td>${round.turnout || 0}%</td>
            <td class="action-buttons">
              <button class="btn btn-xs btn-secondary" onclick="app.viewRoundDetails(${round.round_id})">${i18n.t('admin_modals.voting_history.view_details')}</button>
              <button class="btn btn-xs btn-secondary" onclick="app.exportRoundResults(${round.round_id})">${i18n.t('admin_modals.voting_history.export')}</button>
            </td>
          </tr>
        `;
      });
    } else {
      html += '<tr><td colspan="7" class="text-center text-muted">' + i18n.t('admin_modals.voting_history.no_rounds_found') + '</td></tr>';
    }
    
    html += '</tbody></table>';
    return html;
  }

  // Display treasury transactions
  displayTreasuryTransactions(transactions) {
    const container = document.getElementById('treasury-transactions');
    if (!container) return;
    
    if (!transactions || transactions.length === 0) {
      container.innerHTML = '<div class="text-center text-muted">' + i18n.t('treasury.no_recent_transactions') + '</div>';
      return;
    }
    
    // Create table for transactions
    let html = `
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>${i18n.t('transaction.hash')}</th>
              <th>${i18n.t('transaction.type')}</th>
              <th>${i18n.t('transaction.amount')}</th>
              <th>${i18n.t('transaction.time')}</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    transactions.forEach(tx => {
      const timestamp = new Date(tx.timestamp).toLocaleString();
      html += `
        <tr>
          <td>${tx.hash ? tx.hash.substring(0, 10) + '...' : 'Неизвестно'}</td>
          <td>${tx.type || 'Неизвестно'}</td>
          <td>${this.formatETH(tx.amount)} ETH</td>
          <td>${timestamp}</td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
    
    container.innerHTML = html;
  }

  async showSystemConfig() {
    try {
      const config = await this.fetchJSON('/admin/system/config');
      const modalTitle = i18n.t('admin_modals.system_config.title');
      const modalBody = `
        <div class="form-section">
          <h5>${i18n.t('admin_modals.system_config.smart_contract_addresses')}</h5>
          <div class="form-group">
            <label for="treasury-address">${i18n.t('admin_modals.system_config.treasury_contract')}</label>
            <input type="text" class="form-control" id="treasury-address" value="${config.treasury_address || '0x...'}" readonly>
          </div>
          <div class="form-group">
            <label for="ballot-address">${i18n.t('admin_modals.system_config.ballot_contract')}</label>
            <input type="text" class="form-control" id="ballot-address" value="${config.ballot_address || '0x...'}" readonly>
          </div>
          <div class="form-group">
            <label for="sbt-address">${i18n.t('admin_modals.system_config.sbt_contract')}</label>
            <input type="text" class="form-control" id="sbt-address" value="${config.sbt_address || '0x...'}" readonly>
          </div>
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('admin_modals.system_config.system_parameters')}</h5>
          <div class="form-row">
            <div class="form-group">
              <label for="k-anonymity">${i18n.t('admin_modals.system_config.k_anonymity_threshold')}</label>
              <input type="number" class="form-control" id="k-anonymity" value="${config.k_anonymity_threshold || 5}" min="2">
            </div>
            <div class="form-group">
              <label for="max-export">${i18n.t('admin_modals.system_config.max_export_records')}</label>
              <input type="number" class="form-control" id="max-export" value="${config.max_export_records || 10000}" min="100">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="default-commit-duration">${i18n.t('admin_modals.system_config.default_commit_duration')}</label>
              <input type="number" class="form-control" id="default-commit-duration" value="${config.default_commit_duration || 168}" min="1">
            </div>
            <div class="form-group">
              <label for="default-reveal-duration">${i18n.t('admin_modals.system_config.default_reveal_duration')}</label>
              <input type="number" class="form-control" id="default-reveal-duration" value="${config.default_reveal_duration || 72}" min="1">
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h5>${i18n.t('admin_modals.system_config.security_settings')}</h5>
          <div class="checkbox-group">
            <input type="checkbox" id="enable-privacy-filters" ${config.enable_privacy_filters ? 'checked' : ''}>
            <label for="enable-privacy-filters">${i18n.t('admin_modals.system_config.enable_privacy_filters')}</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="require-sbt-voting" ${config.require_sbt_voting ? 'checked' : ''}>
            <label for="enable-privacy-filters">${i18n.t('admin_modals.system_config.require_sbt_voting')}</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="enable-auto-finalization" ${config.enable_auto_finalization ? 'checked' : ''}>
            <label for="enable-auto-finalization">${i18n.t('admin_modals.system_config.enable_auto_finalization')}</label>
          </div>
        </div>
      `;
      
      const modalFooter = `
        <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
        <button class="btn btn-primary" onclick="app.saveSystemConfig()">${i18n.t('admin_modals.system_config.save_configuration')}</button>
      `;
      
      this.showModal(modalTitle, modalBody, modalFooter);
    } catch (error) {
      console.error('Failed to load system config:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_system_config'));
    }
  }

  displayAdminContent(title, content) {
    document.getElementById('admin-content-title').textContent = title;
    document.getElementById('admin-content-body').innerHTML = content;
  }
  
  // Helper functions for rendering admin tables
  renderWeightsManagementTable(members) {
    let html = `
      <div class="mb-3">
        <button class="btn btn-primary" onclick="app.bulkUpdateWeights()">${i18n.t('admin_modals.member_management.bulk_update_weights')}</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('admin_modals.member_management.address')}</th>
            <th>${i18n.t('admin_modals.member_management.sbt_weight')}</th>
            <th>${i18n.t('admin_modals.member_management.total_donated')}</th>
            <th>${i18n.t('admin_modals.member_management.voting_power')}</th>
            <th>${i18n.t('admin_modals.member_management.actions')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    members.forEach(member => {
      html += `
        <tr>
          <td>${member.address}</td>
          <td>${member.sbtWeight}</td>
          <td>${member.totalDonated}</td>
          <td>${member.votingPower}</td>
          <td>
            <button class="btn btn-warning" onclick="app.editMember('${member.address}')">${i18n.t('admin_modals.member_management.edit')}</button>
            <button class="btn btn-danger" onclick="app.deleteMember('${member.address}')">${i18n.t('admin_modals.member_management.delete')}</button>
          </td>
        </tr>
      `;
    });
    html += '</tbody></table>';
    this.displayAdminContent(i18n.t('admin_modals.member_management.title'), html);
  }

  renderCategoriesManagementTable(categories) {
    let html = `
      <div class="mb-3">
        <button class="btn btn-primary" onclick="app.manageCategories()">' + i18n.t('admin.manage_categories') + '</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('admin_modals.manage_categories.category_name')}</th>
            <th>${i18n.t('admin_modals.manage_categories.active_projects')}</th>
            <th>${i18n.t('admin_modals.manage_categories.max_limit')}</th>
            <th>${i18n.t('admin_modals.manage_categories.actions')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    if (members && members.length > 0) {
      members.forEach(member => {
        html += `
          <tr>
            <td><code>${member.address}</code></td>
            <td>${(member.sbt_weight || 0).toFixed(3)}</td>
            <td>${this.formatETH(member.total_donated || 0)} ETH</td>
            <td>${(member.voting_power || 0).toFixed(3)}</td>
            <td>
              <button class="btn btn-xs btn-secondary" onclick="app.updateMemberWeight('${member.address}')">${i18n.t('admin_modals.member_management.update_weight')}</button>
            </td>
          </tr>
        `;
      });
    } else {
      html += '<tr><td colspan="5" class="text-center text-muted">' + i18n.t('admin_modals.member_management.no_members_found') + '</td></tr>';
    }
    
    html += '</tbody></table>';
    return html;
  }
  
  renderVotingConfigForm(config) {
    return `
      <div class="form-section">
        <h5>${i18n.t('admin_modals.system_config.voting_configuration')}</h5>
        <form id="voting-config-form">
          <div class="form-row">
            <div class="form-group">
              <label for="default-commit-duration">${i18n.t('admin_modals.system_config.default_commit_duration')}</label>
              <input type="number" class="form-control" id="default-commit-duration" value="${config?.default_commit_duration || 168}" min="1">
            </div>
            <div class="form-group">
              <label for="default-reveal-duration">${i18n.t('admin_modals.system_config.default_reveal_duration')}</label>
              <input type="number" class="form-control" id="default-reveal-duration" value="${config?.default_reveal_duration || 72}" min="1">
            </div>
          </div>
          <div class="form-group">
            <label for="counting-method">${i18n.t('admin_modals.system_config.counting_method')}</label>
            <select class="form-control" id="counting-method">
              <option value="weighted" ${config?.counting_method === 'weighted' ? 'selected' : ''}>${i18n.t('admin_modals.system_config.weighted_voting')}</option>
              <option value="borda" ${config?.counting_method === 'borda' ? 'selected' : ''}>${i18n.t('admin_modals.system_config.borda_count')}</option>
            </select>
          </div>
          <button type="button" class="btn btn-primary" onclick="app.saveVotingConfig()">${i18n.t('admin_modals.system_config.save_configuration')}</button>
        </form>
      </div>
    `;
  }
  
  renderLogsTable(logs) {
    let html = `
      <div class="mb-3">
        <button class="btn btn-secondary" onclick="app.refreshLogs()">${i18n.t('refresh_logs')}</button>
        <button class="btn btn-secondary ml-2" onclick="app.exportLogs()">${i18n.t('export_logs')}</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>${i18n.t('time')}</th>
            <th>${i18n.t('level')}</th>
            <th>${i18n.t('module')}</th>
            <th>${i18n.t('message')}</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    if (logs && logs.length > 0) {
      logs.forEach(log => {
        const levelClass = log.level === 'ERROR' ? 'danger' : log.level === 'WARNING' ? 'warning' : 'info';
        html += `
          <tr>
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td><span class="badge badge-${levelClass}">${log.level}</span></td>
            <td>${log.module || 'Неизвестно'}</td>
            <td>${this.escapeHtml(log.message)}</td>
          </tr>
        `;
      });
    } else {
      html += '<tr><td colspan="4" class="text-center text-muted">' + i18n.t('logs_not_found') + '</td></tr>';
    }
    
    html += '</tbody></table>';
    return html;
  }

  // Helper function to refresh the voting interface
  async refreshVotingSection() {
    try {
      console.log('Refreshing voting section...');
      
      // Update current round information
      const currentRound = await this.fetchJSON('/votes/current-round');
      this.displayCurrentVotingRound(currentRound);
      
      // Update voting results
      const votingResults = await this.fetchJSON('/votes/priority/summary');
      this.displayVotingResults(votingResults);
      
      console.log('Voting section refreshed successfully');
    } catch (error) {
      console.error('Error refreshing voting section:', error);
    }
  }
  
  // Helper functions for forms
  showEditCategoryForm(categoryName, categoryData) {
    const modalTitle = i18n.t('edit_category_title', { categoryName: categoryName });
    const modalBody = `
      <form id="edit-category-form">
        <div class="form-group">
          <label for="edit-category-name">${i18n.t('admin_modals.manage_categories.category_name')}</label>
          <input type="text" class="form-control" id="edit-category-name" value="${categoryName}" readonly>
        </div>
        <div class="form-group">
          <label for="edit-category-limit">${i18n.t('admin_modals.manage_categories.max_active_projects')}</label>
          <input type="number" class="form-control" id="edit-category-limit" value="${categoryData.max_limit || 10}" min="1">
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.saveEditCategory('${categoryName}')">${i18n.t('buttons.save')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showEditProjectForm(project) {
    const modalTitle = i18n.t('edit_project_title', { projectName: project.name });
    const modalBody = `
      <form id="edit-project-form">
        <div class="form-group">
          <label for="edit-project-name">${i18n.t('modal.project_name')}</label>
          <input type="text" class="form-control" id="edit-project-name" value="${this.escapeHtml(project.name)}" required>
        </div>
        <div class="form-group">
          <label for="edit-project-description">${i18n.t('modal.description')}</label>
          <textarea class="form-control" id="edit-project-description" required>${this.escapeHtml(project.description)}</textarea>
        </div>
        <div class="form-group">
          <label for="edit-project-category">${i18n.t('modal.category')}</label>
          <input type="text" class="form-control" id="edit-project-category" value="${this.escapeHtml(project.category)}" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-target">${i18n.t('modal.target_amount_eth')}</label>
            <input type="number" class="form-control" id="edit-project-target" value="${project.target}" step="0.01" min="0.01" required>
          </div>
          <div class="form-group">
            <label for="edit-project-soft-cap">${i18n.t('modal.soft_cap_eth')}</label>
            <input type="number" class="form-control" id="edit-project-soft-cap" value="${project.soft_cap}" step="0.01" min="0.01" required>
          </div>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.saveEditProject('${project.id}')">${i18n.t('buttons.save')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showUpdateMemberWeightForm(member) {
    const modalTitle = i18n.t('update_member_weight_title', { address: member.address.substring(0, 8) });
    const modalBody = `
      <form id="update-weight-form">
        <div class="form-group">
          <label for="new-weight">${i18n.t('new_sbt_weight')}</label>
          <input type="number" class="form-control" id="new-weight" value="${member.sbt_weight || 0}" step="0.001" min="0">
        </div>
        <div class="form-group">
          <label for="weight-reason">${i18n.t('weight_change_reason')}</label>
          <textarea class="form-control" id="weight-reason" placeholder="${i18n.t('weight_change_reason_placeholder')}"></textarea>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.saveMemberWeight('${member.address}')">${i18n.t('admin_modals.member_management.update_weight')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showAddProjectForm() {
    const modalTitle = i18n.t('admin_modals.project_management.add_project');
    const modalBody = `
      <form id="add-project-form">
        <div class="form-group">
          <label for="add-project-name">${i18n.t('modal.project_name')}</label>
          <input type="text" class="form-control" id="add-project-name" required>
        </div>
        <div class="form-group">
          <label for="add-project-description">${i18n.t('modal.description')}</label>
          <textarea class="form-control" id="add-project-description" required></textarea>
        </div>
        <div class="form-group">
          <label for="add-project-category">${i18n.t('modal.category')}</label>
          <input type="text" class="form-control" id="add-project-category" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="add-project-target">${i18n.t('modal.target_amount_eth')}</label>
            <input type="number" class="form-control" id="add-project-target" step="0.01" min="0.01" required>
          </div>
          <div class="form-group">
            <label for="add-project-soft-cap">${i18n.t('modal.soft_cap_eth')}</label>
            <input type="number" class="form-control" id="add-project-soft-cap" step="0.01" min="0.01" required>
          </div>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.addProject()">${i18n.t('buttons.add')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showAddMemberForm() {
    const modalTitle = i18n.t('admin_modals.member_management.add_member');
    const modalBody = `
      <form id="add-member-form">
        <div class="form-group">
          <label for="add-member-address">${i18n.t('modal.ens_or_wallet_address')}</label>
          <input type="text" class="form-control" id="add-member-address" required>
        </div>
        <div class="form-group">
          <label for="add-member-role">${i18n.t('modal.role')}</label>
          <select class="form-control" id="add-member-role" required>
            <option value="admin">${i18n.t('roles.admin')}</option>
            <option value="user">${i18n.t('roles.user')}</option>
          </select>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.addMember()">${i18n.t('buttons.add')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showEditMemberForm(member) {
    const modalTitle = i18n.t('admin_modals.member_management.edit_member');
    const modalBody = `
      <form id="edit-member-form">
        <div class="form-group">
          <label for="edit-member-address">${i18n.t('modal.ens_or_wallet_address')}</label>
          <input type="text" class="form-control" id="edit-member-address" value="${this.escapeHtml(member.address)}" required>
        </div>
        <div class="form-group">
          <label for="edit-member-role">${i18n.t('modal.role')}</label>
          <select class="form-control" id="edit-member-role" required>
            <option value="admin"${member.role === 'admin' ? ' selected' : ''}>${i18n.t('roles.admin')}</option>
            <option value="user"${member.role === 'user' ? ' selected' : ''}>${i18n.t('roles.user')}</option>
          </select>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.saveEditMember('${member.address}')">${i18n.t('buttons.save')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showSupportProjectForm(project) {
    const modalTitle = `${i18n.t('titles.support_project')}: ${project.name}`;
    const modalBody = `
      <div class="alert alert-info">
        ${i18n.t('messages.support_project')}
      </div>
      <div class="d-flex justify-content-between">
        <div class="form-group">
          <label for="supportAmount">${i18n.t('labels.support_amount')}</label>
          <input type="number" class="form-control" id="supportAmount" placeholder="${i18n.t('placeholders.support_amount')}">
        </div>
        <div class="form-group">
          <label for="supportPeriod">${i18n.t('labels.support_period')}</label>
          <select class="form-control" id="supportPeriod">
            <option value="1">${i18n.t('periods.month')}</option>
            <option value="12">${i18n.t('periods.year')}</option>
          </select>
        </div>
      </div>
    `;
    const modalFooter = `
      <button class="btn btn-primary" onclick="app.supportProject('${project.id}')">${i18n.t('buttons.support_project')}</button>
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.close')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showBulkUpdateWeightsForm(members) {
    const modalTitle = i18n.t('bulk_update_weights_title');
    const modalBody = `
      <div class="alert alert-info">
        <strong>${i18n.t('instruction')}:</strong> ${i18n.t('bulk_update_weights_instruction')}
      </div>
      <form id="bulk-update-weights-form">
        <div class="form-group">
          <label for="bulk-weight">${i18n.t('new_sbt_weight')}</label>
          <input type="number" class="form-control" id="bulk-weight" step="0.001" min="0" value="1.0">
        </div>
        <div class="form-group">
          <label for="bulk-reason">${i18n.t('weight_change_reason')}</label>
          <textarea class="form-control" id="bulk-reason" placeholder="${i18n.t('bulk_weight_change_reason_placeholder')}"></textarea>
        </div>
        <div class="form-group">
          <label>${i18n.t('select_members')}:</label>
          <div class="member-selection">
            ${members.map(member => `
              <div class="checkbox-group">
                <input type="checkbox" id="member-${member.address}" value="${member.address}" class="member-checkbox">
                <label for="member-${member.address}">
                  ${member.address.substring(0, 8)}... (${i18n.t('current_weight')}: ${(member.sbt_weight || 0).toFixed(3)})
                </label>
              </div>
            `).join('')}
          </div>
        </div>
      </form>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.cancel')}</button>
      <button class="btn btn-primary" onclick="app.saveBulkWeights()">${i18n.t('update_weights')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }
  
  showRoundDetailsModal(roundDetails) {
    const modalTitle = i18n.t('round_details_title', { roundId: roundDetails.round_id });
    const modalBody = `
      <div class="round-details">
        <div class="form-section">
          <h5>${i18n.t('basic_information')}</h5>
          <div class="details-grid">
            <div class="detail-item">
              <label>${i18n.t('status')}:</label>
              <span class="badge badge-${roundDetails.status === 'completed' ? 'success' : 'warning'}">${roundDetails.status}</span>
            </div>
            <div class="detail-item">
              <label>${i18n.t('start_date')}:</label>
              <span>${new Date(roundDetails.start_date).toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <label>${i18n.t('end_date')}:</label>
              <span>${new Date(roundDetails.end_date).toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <label>${i18n.t('participants')}:</label>
              <span>${roundDetails.participants || 0}</span>
            </div>
            <div class="detail-item">
              <label>${i18n.t('turnout')}:</label>
              <span>${roundDetails.turnout || 0}%</span>
            </div>
          </div>
        </div>
        
        ${roundDetails.projects ? `
          <div class="form-section">
            <h5>${i18n.t('projects_in_voting')}</h5>
            <div class="projects-list">
              ${roundDetails.projects.map(project => `
                <div class="project-item">
                  <strong>${this.escapeHtml(project.name)}</strong>
                  <span class="badge badge-info">${this.escapeHtml(project.category)}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    `;
    
    const modalFooter = `
      <button class="btn btn-secondary" onclick="app.closeModal()">${i18n.t('buttons.close')}</button>
      <button class="btn btn-primary" onclick="app.exportRoundResults(${roundDetails.round_id})">${i18n.t('export_results')}</button>
    `;
    
    this.showModal(modalTitle, modalBody, modalFooter);
  }

  async editCategory(categoryName) {
    try {
      const response = await this.fetchJSON(`/admin/categories/${encodeURIComponent(categoryName)}`);
      // Show edit form with current data
      this.showEditCategoryForm(categoryName, response);
    } catch (error) {
      console.error('Failed to fetch category data:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_category_data'));
    }
  }

  async deleteCategory(categoryName) {
    const confirmMessage = `${i18n.t('admin_modals.messages.delete_category_confirm')} "${categoryName}"?`;
    
    if (!confirm(confirmMessage)) {
      return;
    }
    
    try {
      await this.fetchJSON(`/admin/categories/${encodeURIComponent(categoryName)}`, {
        method: 'DELETE'
      });
      
      this.showSuccess(i18n.t('admin_modals.messages.category_deleted_successfully', { name: categoryName }));
      this.manageCategories();
    } catch (error) {
      console.error('Failed to delete category:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_delete_category') + ': ' + error.message);
    }
  }

  async addCategory() {
    const name = document.getElementById('new-category-name').value;
    const limit = document.getElementById('new-category-limit').value;
    
    if (!name) {
      this.showError(i18n.t('admin_modals.messages.category_name_required'));
      return;
    }
    
    try {
      const response = await this.fetchJSON('/admin/categories', {
        method: 'POST',
        body: JSON.stringify({
          name: name,
          max_limit: parseInt(limit) || 10
        })
      });
      
      this.showSuccess(i18n.t('admin_modals.messages.category_added_successfully', { name: name }));
      
      // Clear the form
      document.getElementById('new-category-name').value = '';
      document.getElementById('new-category-limit').value = '10';
      
      // Refresh the categories modal
      this.manageCategories();
    } catch (error) {
      console.error('Failed to add category:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_add_category') + ': ' + error.message);
    }
  }

  async submitMintSBT() {
    const recipient = document.getElementById('sbt-recipient').value;
    const donationAmount = document.getElementById('sbt-donation-amount').value;
    const weightMode = document.getElementById('weight-mode').value;
    
    if (!recipient || !donationAmount) {
      this.showError(i18n.t('validation.fill_required_fields'));
      return;
    }
    
    try {
      const response = await this.fetchJSON('/admin/sbt/mint', {
        method: 'POST',
        body: JSON.stringify({
          recipient_address: recipient,
          donation_amount: parseFloat(donationAmount),
          weight_mode: weightMode
        })
      });
      
      this.showSuccess(i18n.t('admin_modals.messages.sbt_creation_success'));
      this.closeModal();
      
      // Refresh members list if on members admin page
      if (this.currentSection === 'admin') {
        this.showMembersAdmin();
      }
      
    } catch (error) {
      console.error('Failed to mint SBT:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_create_sbt') + ': ' + error.message);
    }
  }

  async submitStartVoting() {
    const selectedProjects = Array.from(document.querySelectorAll('.voting-project:checked')).map(cb => cb.value);
    const commitDuration = document.getElementById('commit-duration')?.value || 168;
    const revealDuration = document.getElementById('reveal-duration')?.value || 72;
    const countingMethod = document.getElementById('counting-method')?.value || 'borda';
    const autoCancellation = document.getElementById('enable-auto-cancellation')?.checked || false;
    const cancellationThreshold = document.getElementById('cancellation-threshold')?.value || 66;
    
    if (selectedProjects.length === 0) {
      this.showError(i18n.t('validation.select_at_least_one_project'));
      return;
    }
    
    try {
      // Show loading indicator
      const submitButton = document.querySelector('button[onclick="app.submitStartVoting()"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = i18n.t('starting');
      }
      
      // Prepare data to send
      const votingData = {
        projects: selectedProjects,
        commit_duration_hours: parseInt(commitDuration),
        reveal_duration_hours: parseInt(revealDuration),
        counting_method: countingMethod,
        enable_auto_cancellation: autoCancellation,
        auto_cancellation_threshold: parseInt(cancellationThreshold)
      };
      
      // Try to make API call
      const response = await this.fetchJSON('/admin/voting/start-round', {
        method: 'POST',
        body: JSON.stringify(votingData)
      });
      
      // Show result
      if (response.status === 'success' || response.round_id) {
        this.showSuccess(i18n.t('voting.round_started_successfully', { roundId: response.round_id || 'Неизвестно', count: selectedProjects.length }));
        
        // Refresh voting interface
        await this.refreshVotingSection();
        
        // Close modal
        this.closeModal();
        
        // Switch to voting section
        this.switchSection('voting');
      } else {
        throw new Error(response.message || i18n.t('unknown_error'));
      }
      
    } catch (error) {
      console.error('Error starting voting round:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_start_voting_round') + ': ' + error.message);
    } finally {
      // Restore button
      const submitButton = document.querySelector('button[onclick="app.submitStartVoting()"]');
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = i18n.t('admin_modals.start_voting.start_voting_round');
      }
    }
  }

  async manageWeights() { 
    try {
      const members = await this.fetchJSON('/members?limit=100');
      this.displayAdminContent(i18n.t('admin_modals.member_management.title'), this.renderWeightsManagementTable(members));
    } catch (error) {
      console.error('Failed to load members for weight management:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_members_for_weight_management'));
    }
  }
  
  async bulkUpdateWeights() {
    try {
      const members = await this.fetchJSON('/members?limit=100');
      this.showBulkUpdateWeightsForm(members);
    } catch (error) {
      console.error('Failed to load members for bulk update:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_members_for_bulk_update'));
    }
  }
  
  async showVotingConfig() { 
    try {
      const config = await this.fetchJSON('/admin/voting/config');
      this.displayAdminContent(i18n.t('admin_modals.system_config.title'), this.renderVotingConfigForm(config));
    } catch (error) {
      console.error('Failed to load voting config:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_voting_config'));
    }
  }
  
  async showLogsAdmin() { 
    try {
      const logs = await this.fetchJSON('/admin/logs?limit=100');
      this.displayAdminContent(i18n.t('system_logs'), this.renderLogsTable(logs));
    } catch (error) {
      console.error('Failed to load system logs:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_system_logs'));
    }
  }
  // Helper function to get project name by ID
  getProjectNameById(id) {
    // Try to find project name in table headers
    const adminContentBody = document.getElementById('admin-content-body');
    if (adminContentBody) {
      const projectRow = adminContentBody.querySelector(`button[onclick*="'${id}'"]`);
      if (projectRow) {
        const rowElement = projectRow.closest('tr');
        if (rowElement) {
          const nameCell = rowElement.querySelector('td:first-child strong');
          if (nameCell) {
            return nameCell.textContent;
          }
        }
      }
    }
    
    // If not found, return shortened ID
    return id.length > 20 ? id.substring(0, 20) + '...' : id;
  }

  async editProject(id) { 
    try {
      const project = await this.fetchJSON(`/projects/${id}`);
      this.showEditProjectForm(project);
    } catch (error) {
      console.error('Failed to fetch project data:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_project_data'));
    }
  }
  
  async pauseProject(id) { 
    try {
      const response = await this.fetchJSON(`/admin/projects/${id}/pause`, {
        method: 'POST'
      });
      
      this.showSuccess(i18n.t('admin_modals.messages.project_suspension_success'));
      this.showProjectsAdmin();
    } catch (error) {
      console.error('Failed to pause project:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_suspend_project') + ': ' + error.message);
    }
  }
  async cancelProject(id) { 
    // Show confirmation dialog
    const projectName = this.getProjectNameById(id);
    const confirmMessage = i18n.t('admin_modals.project_management.confirm_cancel_project', { projectName: projectName });
    
    if (!confirm(confirmMessage)) {
      return;
    }
    
    try {
      // Send request to cancel project
      const response = await this.fetchJSON(`/admin/projects/${id}/cancel`, {
        method: 'POST',
        body: JSON.stringify({
          reason: i18n.t('admin_modals.project_management.cancelled_by_admin')
        })
      });
      
      this.showSuccess(i18n.t('admin_modals.messages.project_cancelled_successfully', { projectName: projectName }));
      
      // Refresh project list
      this.showProjectsAdmin();
      
    } catch (error) {
      console.error('Error canceling project:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_cancel_project') + ': ' + error.message);
    }
  }
  
  async deleteProject(id) {
    // Show confirmation dialog
    const projectName = this.getProjectNameById(id);
    const confirmMessage = i18n.t('admin_modals.project_management.delete_project_confirm', { projectName: projectName });
    
    const userInput = prompt(confirmMessage);
    
    if (userInput !== 'DELETE') {
      if (userInput !== null) { // User did not cancel dialog
        this.showWarning(i18n.t('admin_modals.project_management.delete_cancelled'));
      }
      return;
    }
    
    try {
      // Send request for complete deletion
      const response = await this.fetchJSON(`/admin/projects/${id}`, {
        method: 'DELETE'
      });
      
      this.showSuccess(i18n.t('admin_modals.project_management.project_deleted_successfully', { projectName: projectName }));
      
      // Update project list
      this.showProjectsAdmin();
      
    } catch (error) {
      console.error('Error deleting project:', error);
      this.showError(i18n.t('admin_modals.project_management.failed_to_delete_project') + ': ' + error.message);
    }
  }
  
  async updateMemberWeight(address) { 
    try {
      const member = await this.fetchJSON(`/members/${address}`);
      this.showUpdateMemberWeightForm(member);
    } catch (error) {
      console.error('Failed to fetch member data:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_member_data_for_weight_update'));
    }
  }
  
  async toggleMemberStatus(address) { 
    try {
      const response = await this.fetchJSON(`/admin/members/${address}/toggle-status`, {
        method: 'POST'
      });
      
      this.showSuccess(i18n.t('admin.member_status_success'));
      this.showMembersAdmin();
    } catch (error) {
      console.error('Failed to toggle member status:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_toggle_member_status') + ': ' + error.message);
    }
  }
  
  async viewRoundDetails(roundId) { 
    try {
      const roundDetails = await this.fetchJSON(`/admin/voting/rounds/${roundId}`);
      this.showRoundDetailsModal(roundDetails);
    } catch (error) {
      console.error('Failed to fetch round details:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_load_voting_round_details'));
    }
  }
  
  async exportRoundResults(roundId) { 
    try {
      await this.performExport(`/admin/voting/rounds/${roundId}/export`, `round_${roundId}_results`, 'csv');
    } catch (error) {
      console.error('Failed to export round results:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_export_round_results') + ': ' + error.message);
    }
  }
  async saveSystemConfig() { 
    try {
      // Get data from form
      const configData = {
        k_anonymity_threshold: parseInt(document.getElementById('k-anonymity')?.value || '5'),
        max_export_records: parseInt(document.getElementById('max-export')?.value || '10000'),
        default_commit_duration: parseInt(document.getElementById('default-commit-duration')?.value || '168'),
        default_reveal_duration: parseInt(document.getElementById('default-reveal-duration')?.value || '72'),
        enable_privacy_filters: document.getElementById('enable-privacy-filters')?.checked || false,
        require_sbt_voting: document.getElementById('require-sbt-voting')?.checked || false,
        enable_auto_finalization: document.getElementById('enable-auto-finalization')?.checked || false
      };
      
      const response = await this.fetchJSON('/admin/system/config', {
        method: 'POST',
        body: JSON.stringify(configData)
      });
      
      this.showSuccess(i18n.t('admin.system_settings_success'));
      this.closeModal();
    } catch (error) {
      console.error('Error saving system config:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_save_system_config') + ': ' + error.message);
    }
  }
  
  // Additional save functions
  async saveEditCategory(categoryName) {
    try {
      const newLimit = parseInt(document.getElementById('edit-category-limit').value);
      
      const response = await this.fetchJSON(`/admin/categories/${encodeURIComponent(categoryName)}`, {
        method: 'PUT',
        body: JSON.stringify({
          max_limit: newLimit
        })
      });
      
      this.showSuccess(i18n.t('admin.category_update_success'));
      this.closeModal();
      this.manageCategories();
    } catch (error) {
      console.error('Error updating category:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_update_category') + ': ' + error.message);
    }
  }
  
  async saveEditProject(projectId) {
    try {
      const projectData = {
        name: document.getElementById('edit-project-name').value,
        description: document.getElementById('edit-project-description').value,
        category: document.getElementById('edit-project-category').value,
        target: parseFloat(document.getElementById('edit-project-target').value),
        soft_cap: parseFloat(document.getElementById('edit-project-soft-cap').value)
      };
      
      const response = await this.fetchJSON(`/admin/projects/${projectId}`, {
        method: 'PUT',
        body: JSON.stringify(projectData)
      });
      
      this.showSuccess(i18n.t('projects.update_success'));
      this.closeModal();
      this.showProjectsAdmin();
    } catch (error) {
      console.error('Error updating project:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_update_project') + ': ' + error.message);
    }
  }
  
  async saveMemberWeight(address) {
    try {
      const newWeight = parseFloat(document.getElementById('new-weight').value);
      const reason = document.getElementById('weight-reason').value;
      
      const response = await this.fetchJSON(`/admin/members/${address}/weight`, {
        method: 'PUT',
        body: JSON.stringify({
          sbt_weight: newWeight,
          reason: reason
        })
      });
      
      this.showSuccess(i18n.t('admin.member_weight_success'));
      this.closeModal();
      this.showMembersAdmin();
    } catch (error) {
      console.error('Error updating member weight:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_update_member_weight') + ': ' + error.message);
    }
  }
  
  async saveBulkWeights() {
    try {
      const newWeight = parseFloat(document.getElementById('bulk-weight').value);
      const reason = document.getElementById('bulk-reason').value;
      const selectedMembers = Array.from(document.querySelectorAll('.member-checkbox:checked')).map(cb => cb.value);
      
      if (selectedMembers.length === 0) {
        this.showError(i18n.t('admin_modals.messages.select_at_least_one_member'));
        return;
      }
      
      const response = await this.fetchJSON('/admin/members/bulk-update-weights', {
        method: 'POST',
        body: JSON.stringify({
          addresses: selectedMembers,
          new_weight: newWeight,
          reason: reason
        })
      });
      
      this.showSuccess(i18n.t('admin_modals.messages.member_weights_updated_successfully', { count: selectedMembers.length }));
      this.closeModal();
      this.manageWeights();
    } catch (error) {
      console.error('Error bulk updating weights:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_bulk_update_weights') + ': ' + error.message);
    }
  }
  
  async saveVotingConfig() {
    try {
      const configData = {
        default_commit_duration: parseInt(document.getElementById('default-commit-duration').value),
        default_reveal_duration: parseInt(document.getElementById('default-reveal-duration').value),
        counting_method: document.getElementById('counting-method').value
      };
      
      const response = await this.fetchJSON('/admin/voting/config', {
        method: 'POST',
        body: JSON.stringify(configData)
      });
      
      this.showSuccess(i18n.t('voting.settings_success'));
      this.closeModal();
    } catch (error) {
      console.error('Error saving voting config:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_save_voting_config') + ': ' + error.message);
    }
  }
  
  // Additional utility functions
  async refreshLogs() {
    try {
      await this.showLogsAdmin();
    } catch (error) {
      console.error('Error refreshing logs:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_refresh_logs'));
    }
  }
  
  async exportLogs() {
    try {
      await this.performExport('/admin/logs/export', 'system_logs', 'csv');
    } catch (error) {
      console.error('Error exporting logs:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_export_logs'));
    }
  }
  
  // Reset voting status for current user (for admin)
  async resetVotingStatus() {
    try {
      const currentRound = await this.fetchJSON('/votes/current-round');
      if (currentRound && currentRound.round_id) {
        this.resetUserVotingStatus(currentRound.round_id);
        this.showSuccess(i18n.t('voting.reset_success', { round_id: currentRound.round_id }));
      } else {
        this.showWarning(i18n.t('voting.no_active_round'));
      }
    } catch (error) {
      console.error('Error resetting voting status:', error);
      this.showError(i18n.t('voting.reset_error'));
    }
  }

  async startVoting() {
    try {
      const response = await this.fetchJSON('/admin/voting/start', {
        method: 'POST'
      });
      
      this.showSuccess(i18n.t('voting.round_start_success'));
      this.loadVotingSection();
    } catch (error) {
      console.error('Failed to start voting:', error);
      this.showError(i18n.t('admin_modals.messages.failed_to_start_voting') + ': ' + error.message);
    }
  }
}

// Global functions for onclick handlers
window.showCreateProject = () => window.app.showProjectForm();
window.loadPersonalStats = () => window.app.loadPersonalStats();
window.exportTreasuryData = () => window.app.exportTreasuryData();
window.exportPersonalData = () => window.app.exportPersonalData();
window.showProjectForm = () => window.app.showProjectForm();
window.manageCategories = () => window.app.manageCategories();
window.mintSBT = () => window.app.showMintSBTForm();
window.manageWeights = () => window.app.manageWeights();
window.startVotingRound = () => window.app.showStartVotingForm();
window.configureVoting = () => window.app.showVotingConfig();
window.reindexBlockchain = () => window.app.reindexBlockchain();
window.startVoting = () => window.app.startVoting();
window.resetVotingStatus = () => window.app.resetVotingStatus();

// Initialize the application
function initializeApp() {
  console.log('Initializing FundChain app...');
  window.app = new FundChainApp();
  console.log('App object created:', window.app);
}

// Wait for DOM to be ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}

// Handle page unload
window.addEventListener('beforeunload', () => {
  if (window.app) {
    window.app.stopAutoRefresh();
  }
});
