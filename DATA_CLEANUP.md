# Скрипт очистки данных FundChain

Этот документ описывает скрипты для очистки тестовых данных в проекте FundChain.

## Обзор

Скрипты очистки предназначены для:
- Полной очистки базы данных перед новым тестированием
- Создания резервных копий данных
- Очистки временных файлов и логов
- Проверки статистики данных

## Доступные скрипты

### 1. cleanup.sh (Основной bash-скрипт)

Bash-обертка для удобного запуска очистки данных.

```bash
# Полная очистка с резервной копией (рекомендуется)
./scripts/cleanup.sh

# Быстрая очистка без резервной копии
./scripts/cleanup.sh --quick

# Показать только статистику данных
./scripts/cleanup.sh --stats

# Запуск без Docker (для локальной разработки)
./scripts/cleanup.sh --no-docker
```

### 2. cleanup_data.py (Python-скрипт)

Основной скрипт очистки на Python.

```bash
# Полная очистка с резервной копией
python3 scripts/cleanup_data.py

# Быстрая очистка без резервной копии
python3 scripts/cleanup_data.py --no-backup

# Только статистика
python3 scripts/cleanup_data.py --stats-only
```

### 3. Команды Makefile

Интегрированные команды в Makefile для удобства:

```bash
# Полная очистка данных
make cleanup

# Быстрая очистка данных
make cleanup-quick

# Статистика данных
make cleanup-stats
```

## Что очищается

### База данных
- Все таблицы полностью очищаются и пересоздаются
- Выполняется оптимизация базы данных (VACUUM)
- Опционально создается резервная копия

### Временные файлы
- `*.tmp`, `*.temp` - временные файлы
- `*~` - файлы резервных копий
- `*.pyc` - скомпилированные Python файлы
- `__pycache__/` - кэш Python
- `.pytest_cache/` - кэш pytest

### Лог-файлы
- Очищается содержимое старых лог-файлов
- Текущий лог cleanup.log сохраняется

## Резервные копии

Резервные копии создаются автоматически и сохраняются в директории `backups/`:

```
backups/
├── backup_before_cleanup_20240123_145630.db
├── backup_before_cleanup_20240123_162145.db
└── ...
```

Формат имени: `backup_before_cleanup_YYYYMMDD_HHMMSS.db`

## Логирование

Логи сохраняются в директории `logs/`:

```
logs/
├── cleanup.log      # Основной лог очистки
├── app.log         # Лог приложения
└── ...
```

## Примеры использования

### Подготовка к тестированию

```bash
# 1. Проверить текущую статистику
make cleanup-stats

# 2. Выполнить полную очистку
make cleanup

# 3. Запустить новое тестирование
make test-10-setup
make test-10-full
```

### Быстрая очистка для разработки

```bash
# Быстрая очистка без резервной копии
make cleanup-quick

# Или напрямую
./scripts/cleanup.sh --quick
```

### Проверка данных без очистки

```bash
# Показать статистику всех таблиц
make cleanup-stats

# Или с подробностями
python3 scripts/cleanup_data.py --stats-only
```

## Безопасность

### Резервные копии
- По умолчанию всегда создается резервная копия
- Используйте `--no-backup` только если уверены
- Резервные копии можно восстановить вручную

### Проверки
- Скрипт проверяет соединение с базой данных
- Выполняется проверка результатов очистки
- Все операции логируются

### Обработка ошибок
- Строгая обработка ошибок в bash (`set -euo pipefail`)
- Корректное завершение при прерывании (Ctrl+C)
- Автоматический перезапуск сервисов

## Устранение неполадок

### Ошибка "Database connection failed"
```bash
# Проверить статус Docker контейнеров
docker-compose ps

# Перезапустить контейнеры
docker-compose restart

# Попробовать без Docker
./scripts/cleanup.sh --no-docker
```

### Ошибка "Permission denied"
```bash
# Убедиться что скрипты исполняемые
chmod +x scripts/cleanup.sh
chmod +x scripts/cleanup_data.py
```

### Ошибка импорта Python модулей
```bash
# Проверить что вы в корневой директории проекта
cd /path/to/community-fundchain

# Проверить Python путь
export PYTHONPATH="$PWD:$PYTHONPATH"
```

## Интеграция с рабочими процессами

### Перед тестированием
```bash
# Полный цикл подготовки к тестированию
make cleanup          # Очистка данных
make test-10-setup    # Создание тестовых данных
make test-10-full     # Запуск тестов
```

### В CI/CD
```bash
# В автоматизированных сценариях
./scripts/cleanup.sh --quick --no-docker
```

### Ежедневная очистка
```bash
# Можно добавить в cron для ежедневной очистки
0 2 * * * cd /path/to/project && make cleanup-quick
```

## Структура директорий после очистки

```
community-fundchain/
├── backups/                    # Резервные копии
│   └── backup_before_cleanup_*.db
├── logs/                       # Файлы логов
│   ├── cleanup.log
│   └── *.log (очищены)
├── backend/
│   └── fundchain.db           # Чистая база данных
└── scripts/
    ├── cleanup.sh             # Bash-скрипт
    └── cleanup_data.py        # Python-скрипт
```

## Дополнительные возможности

### Проверка целостности данных
Скрипт автоматически проверяет результаты очистки и сообщает о любых оставшихся данных.

### Настройка логирования
Можно изменить уровень логирования в `cleanup_data.py`:
```python
logging.basicConfig(level=logging.DEBUG)  # Для подробного логирования
```

### Кастомизация очистки
Можно модифицировать списки файлов для очистки в функции `cleanup_temp_files()`.

## Рекомендации

1. **Всегда используйте резервные копии** при работе с важными данными
2. **Проверяйте статистику** перед очисткой
3. **Ведите лог** всех операций очистки
4. **Используйте Make команды** для единообразия
5. **Тестируйте очистку** на тестовых данных перед продакшеном